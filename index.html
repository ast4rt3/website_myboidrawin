<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICS Lab Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #cbd3f4 0%, #003A72 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, hsl(231, 69%, 61%) 0%, #00396E 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .auto-refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            margin-left: 15px;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            opacity: 0.8;
        }

        .auto-refresh-indicator i {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }


        .controls {
            background: #f8fafc;
            padding: 30px 40px;
            border-bottom: 1px solid #e2e8f0;
        }

        .control-group {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 45px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .pc-status-container {
            padding: 30px 40px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid #e2e8f0;
        }

        .pc-status-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .pc-status-card:hover {
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .pc-status-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .status-indicator-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #22c55e;
            position: relative;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        .status-indicator.offline {
            background: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline::after {
            animation: none;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            70% {
                transform: scale(2.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        .pc-info h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: #1f2937;
            font-weight: 700;
        }

        .pc-info .status-text {
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pc-info .status-text i {
            font-size: 0.9rem;
        }

        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .system-info-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #4f46e5;
        }

        .system-info-item .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .system-info-item .value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px 40px;
            background: #f8fafc;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #4f46e5;
        }

        .stat-card .number {
            font-size: 2.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #64748b;
        }

        .tab-content {
            padding: 30px 40px;
            display: none;
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 0 auto;
        }

        .chart-container canvas {
            max-height: 400px !important;
            max-width: 100% !important;
            width: 100% !important;
            height: 400px !important;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
        }

        tr:hover {
            background: #f8fafc;
        }


        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #374151;
        }

        /* Task Manager Styles */
        .task-manager-header-section {
            margin-bottom: 20px;
        }

        .task-manager-graph-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .graph-label {
            font-weight: 600;
            color: #374151;
        }

        .graph-time-label {
            color: #64748b;
        }

        .graph-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .task-manager-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-manager-stats-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-manager-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .task-manager-stat-item:last-child {
            border-bottom: none;
        }

        .task-manager-stat-item .stat-label {
            font-size: 0.9rem;
            color: #64748b;
        }

        .task-manager-stat-item .stat-value {
            font-size: 0.95rem;
            color: #1f2937;
            font-weight: 500;
        }

        .task-manager-stat-item .stat-value-large {
            font-size: 1.5rem;
            color: #1f2937;
            font-weight: 600;
        }

        .task-manager-memory-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #64748b;
        }

        /* Home/Dashboard Page Styles */
        .home-container {
            padding: 30px 40px;
            display: none;
        }

        .home-container.active {
            display: block;
        }

        .pcs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pc-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pc-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #4f46e5;
        }

        .pc-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .pc-card-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }

        .pc-card-status.offline {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .pc-card-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            flex: 1;
        }

        .pc-card-info {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 10px;
        }

        .pc-card-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .pc-card-info-item:last-child {
            border-bottom: none;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-toggle-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
        }

        .view-toggle-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: #64748b;
            margin-bottom: 30px;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            padding: 10px 20px;
            color: #64748b;
            font-weight: 600;
        }

        .pagination-page-numbers {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .page-number {
            padding: 8px 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
        }

        .page-number:hover {
            background: #f8fafc;
            border-color: #4f46e5;
        }

        .page-number.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .error {
            background: #ef4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }

            .header .subtitle {
                font-size: 0.85rem;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .auto-refresh-indicator {
                margin-left: 0;
                margin-top: 10px;
                font-size: 0.75rem;
            }

            .controls {
                padding: 20px 15px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .form-group label {
                font-size: 0.85rem;
            }

            .form-group input, .form-group select {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px 15px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-card i {
                font-size: 2rem;
            }

            .stat-card .number {
                font-size: 1.8rem;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .chart-container {
                padding: 20px 15px;
            }

            .chart-wrapper {
                height: 300px;
            }

            .data-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
                font-size: 0.75rem;
            }

            th, td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }

            .pcs-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .pc-card {
                padding: 15px;
            }

            .pc-card-name {
                font-size: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .page-subtitle {
                font-size: 0.9rem;
            }

            .pagination {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .pagination-btn {
                width: 100%;
                max-width: 200px;
                padding: 12px 20px;
            }

            .pagination-info {
                padding: 10px;
                font-size: 0.9rem;
                text-align: center;
            }

            .pagination-page-numbers {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
            }

            .page-number {
                padding: 6px 10px;
                font-size: 0.85rem;
                min-width: 35px;
            }

            .home-container {
                padding: 15px;
            }

            .pc-status-container {
                padding: 15px;
            }

            .pc-status-card {
                padding: 20px;
            }

            .pc-status-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .system-info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .view-toggle {
                flex-direction: column;
                gap: 10px;
            }

            .view-toggle-btn {
                width: 100%;
                padding: 12px 20px;
            }

            .pc-card-info-item {
                font-size: 0.8rem;
            }

            /* Shareable link section mobile */
            #shareableLink {
                font-size: 0.8rem;
                padding: 10px;
            }

            /* PC status card shareable link */
            .pc-status-card > div:last-child {
                flex-direction: column;
                gap: 10px;
            }

            .pc-status-card > div:last-child > div {
                flex-direction: column;
                width: 100%;
            }

            .task-manager-container {
                padding: 15px;
            }

            .task-manager-stats-grid {
                grid-template-columns: 1fr;
            }

            .task-manager-memory-stats {
                grid-template-columns: 1fr;
            }

            .pc-status-card > div:last-child input {
                width: 100%;
                min-width: auto;
            }

            .pc-status-card > div:last-child button {
                width: 100%;
            }

           

            
      /* Analytics charts wrapper - REMOVED max-width constraint to fill parent section */
        #analyticsSection .analytics-charts {
            width: 100%; /* Ensure it takes full width of the parent #analyticsSection (max 980px) */
            /* max-width: 900px; <--- This line should be REMOVED or commented out */
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 32px;
            box-sizing: border-box;
        }

        /* Each chart card uses a fixed height so Chart.js can measure the canvas */
        #analyticsSection .chart-card {
            background: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.04);
        }

        /* IMPORTANT: a wrapper with an explicit height so Chart.js has a measurable layout */
        #analyticsSection .chart-card .chart-wrapper {
            height: 320px;           /* desktop fixed height */
            min-height: 320px;
            position: relative;
        }

        /* Make canvases fill their wrapper - use 100% of the wrapper's height */
        #analyticsSection canvas {
            width: 100% !important; /* This is the correct rule for the canvas itself */
            height: 100% !important;
            max-height: 320px !important;
            display: block;
        }

        @media (max-width: 768px) {
            #analyticsSection {
                padding: 12px;
            }
            #analyticsSection .chart-card .chart-wrapper {
                height: 240px;
            }
            #analyticsSection canvas {
                max-height: 240px !important;
            }
        }

        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-desktop"></i> ICS Lab Monitor</h1>
            <div class="subtitle" id="headerSubtitle">
                <span id="headerText">Enter PC name to get started</span>
                <span class="auto-refresh-indicator" id="refreshIndicator" style="display: none;">
                    <i class="fas fa-sync-alt"></i>
                    <span id="lastUpdateTime">Auto-refreshing...</span>
                </span>
            </div>
        </div>

        <div class="view-toggle">
            <button class="view-toggle-btn active" data-page="home" onclick="showHomePage(event)">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="view-toggle-btn" data-page="detail" onclick="showDetailPage(event)">
                <i class="fas fa-desktop"></i> PC Details
            </button>
            <button class="view-toggle-btn" data-page="analytics" onclick="showAnalyticsPage(event)">
                <i class="fas fa-chart-line"></i> Analytics
            </button>
        </div>

        <!-- Home/Dashboard Page -->
        <div class="home-container active" id="homePage">
            <h2 class="page-title">Available PCs</h2>
            <p class="page-subtitle">Click on a PC to view its details and activity</p>
            <div class="pcs-grid" id="pcsGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading PCs...
                </div>
            </div>
        </div>

        <!-- Detail Page -->
        <div class="home-container" id="detailPage">
            <div class="controls">
                <div class="control-group">
                    <div class="form-group">
                        <label for="pcName"><i class="fas fa-desktop"></i> PC Name</label>
                        <input type="text" id="pcName" placeholder="Enter PC name (e.g., i3S)">
                    </div>
                    <div class="form-group">
                        <label for="selectedDate"><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="selectedDate">
                    </div>
                    <button class="btn" onclick="loadData()">
                        <i class="fas fa-search"></i>
                        Load Data
                    </button>
                    <button class="btn" onclick="toggleTaskManager()" id="taskManagerBtn" style="background: #4f46e5; color: white;">
                        <i class="fas fa-tasks"></i>
                        <span id="taskManagerBtnText">Show Processes</span>
                    </button>
                    
                </div>
            </div>

        <!-- PC Status Card -->
        <div class="pc-status-container" id="pcStatusContainer" style="display:none;">
            <div class="pc-status-card">
                <div class="pc-status-header">
                    <div class="status-indicator-wrapper">
                        <div class="status-indicator" id="statusIndicator"></div>
                    </div>
                    <div class="pc-info">
                        <h2 id="pcDisplayName"></h2>
                        <div class="status-text" id="pcStatusText">
                            <i class="fas fa-circle"></i>
                            <span>Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="system-info-grid" id="systemInfoGrid">
                    <!-- System info will be populated here -->
                </div>
                
                <!-- Task Manager Section -->
                <div id="taskManagerSection" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 2px solid #e5e7eb;">
                    <div class="task-manager-header-section">
                        <h3 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 5px;">CPU</h3>
                        <div class="cpu-info-header" id="cpuInfoHeader" style="font-size: 0.9rem; color: #64748b;">
                            <span id="cpuModel">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="task-manager-graph-container">
                        <div class="graph-header">
                            <span class="graph-label">% Utilization</span>
                            <span class="graph-time-label">60 seconds</span>
                        </div>
                        <div class="graph-wrapper">
                            <canvas id="cpuUtilizationChart"></canvas>
                        </div>
                    </div>

                    <div class="task-manager-stats-grid">
                        <div class="task-manager-stats-column">
                            <div class="task-manager-stat-item">
                                <div class="stat-label">Utilization</div>
                                <div class="stat-value-large" id="cpuUtilization">0%</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">Speed</div>
                                <div class="stat-value-large" id="cpuSpeed">0.00 GHz</div>
                            </div>
                        </div>
                        
                        <div class="task-manager-stats-column">
                            <div class="task-manager-stat-item">
                                <div class="stat-label">Base speed</div>
                                <div class="stat-value" id="baseSpeed">-</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">Sockets</div>
                                <div class="stat-value" id="sockets">-</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">Cores</div>
                                <div class="stat-value" id="cores">-</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">Logical processors</div>
                                <div class="stat-value" id="logicalProcessors">-</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">Virtualization</div>
                                <div class="stat-value" id="virtualization">-</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">L1 cache</div>
                                <div class="stat-value" id="l1Cache">-</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">L2 cache</div>
                                <div class="stat-value" id="l2Cache">-</div>
                            </div>
                            <div class="task-manager-stat-item">
                                <div class="stat-label">L3 cache</div>
                                <div class="stat-value" id="l3Cache">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="task-manager-header-section" style="margin-top: 40px;">
                        <h3 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 5px;">Memory</h3>
                    </div>
                    
                    <div class="task-manager-graph-container">
                        <div class="graph-header">
                            <span class="graph-label">Memory Usage (GB)</span>
                            <span class="graph-time-label">60 seconds</span>
                        </div>
                        <div class="graph-wrapper">
                            <canvas id="memoryUtilizationChart"></canvas>
                        </div>
                    </div>

                    <div class="task-manager-memory-stats">
                        <div class="task-manager-stat-item">
                            <div class="stat-label">In use</div>
                            <div class="stat-value-large" id="memoryInUse">0 GB</div>
                        </div>
                        <div class="task-manager-stat-item">
                            <div class="stat-label">Available</div>
                            <div class="stat-value-large" id="memoryAvailable">0 GB</div>
                        </div>
                        <div class="task-manager-stat-item">
                            <div class="stat-label">Committed</div>
                            <div class="stat-value" id="memoryCommitted">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Shareable Link Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <label style="font-size: 0.85rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">
                            <i class="fas fa-link"></i> Direct Link:
                        </label>
                        <input type="text" id="shareableLink" readonly 
                            style="flex: 1; min-width: 200px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background: #f8fafc; color: #374151;"
                            value="">
                        <button onclick="copyLink()" 
                            style="padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <p style="margin-top: 8px; font-size: 0.75rem; color: #64748b; font-style: italic;">
                        <i class="fas fa-info-circle"></i> Use this link for RFID tags or QR codes
                    </p>
                </div>
            </div>
        </div>

        <div id="statsGrid" class="stats-grid" style="display: none;"></div>

         <div id="apps-tab" class="tab-content" style="display: none;">
            <div class="chart-container">
                <div class="chart-title">App Usage Distribution</div>
                <div class="chart-wrapper">
                    <canvas id="appUsageChart"></canvas>
                </div>
            </div>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Duration</th>
                            <th>Memory</th>
                            <th>CPU</th>
                        </tr>
                    </thead>
                    <tbody id="appTableBody">
                        <!-- App data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
             <!-- Pagination Controls -->
            <div class="pagination" id="paginationControls" style="display: none;">
                <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div class="pagination-page-numbers" id="pageNumbers"></div>
                <div class="pagination-info" id="paginationInfo"></div>
                <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Analytics Page -->
        <div class="home-container" id="analyticsPage">
            <h2 class="page-title">Analytics Reports</h2>
            <p class="page-subtitle">Performance and usage summary across all PCs and the selected PC</p>
            <div class="controls" style="margin-bottom:20px;">
                <div class="control-group" style="align-items:flex-start;">
                    <div class="form-group">
                        <label for="analyticsRangeSelect"><i class="fas fa-clock"></i> Range</label>
                        <select id="analyticsRangeSelect" onchange="handleAnalyticsRangeChange()">
                            <option value="today" selected>Today</option>
                            <option value="last3">Last 3 days</option>
                            <option value="last5">Last 5 days</option>
                            <option value="last30">Last 30 days</option>
                            <option value="custom">Custom Date</option>
                        </select>
                    </div>
                    <div class="form-group" id="analyticsCustomDateGroup" style="display:none;">
                        <label for="analyticsCustomDate"><i class="fas fa-calendar-day"></i> Custom Date</label>
                        <input type="date" id="analyticsCustomDate">
                    </div>
                    <button class="btn" style="background:#7933ea; color:white; margin-left:auto;" onclick="showAnalyticsReports()" id="analyticsLoadBtn">
                        <i class="fas fa-sync-alt"></i>
                        Load Analytics
                    </button>
                </div>
            </div>
            <div id="analyticsPlaceholder" class="loading">
                Select a PC, pick a range, then click "Load Analytics"
            </div>

            <div id="analyticsSection" style="display:none; margin-top:30px;">
                <div style="max-width:980px; margin:0 auto; padding:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                        <div>
                            <h3 style="font-size:1.6rem; font-weight:700; color:#1f2937; margin-bottom:5px;">Analytics Reports</h3>
                            <p style="color:#64748b; margin-bottom:0;">Performance and usage summary across all PCs and the selected PC</p>
                        </div>
                        <button onclick="downloadAnalyticsCSV()" style="background:linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color:white; padding:10px 20px; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:8px; transition:all 0.3s;">
                            <i class="fas fa-download" style="font-size:0.9rem;"></i>
                            Export CSV
                        </button>
                    </div>

                    <!-- Summary Cards (FIRST) -->
                    <div id="analyticsSummaryCards" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:20px; margin-bottom:40px;">
                        <div class="summary-card" style="background:#eef2ff; padding:20px; border-radius:12px; text-align:center;">
                            <h4 style="margin:0; font-size:0.9rem; color:#6366f1; font-weight:600;">Total Active Time</h4>
                            <p id="totalActiveTime" style="font-size:1.8rem; font-weight:700; color:#1e3a8a; margin:10px 0 0 0;">-</p>
                        </div>
                        <div class="summary-card" style="background:#ecfdf5; padding:20px; border-radius:12px; text-align:center;">
                            <h4 style="margin:0; font-size:0.9rem; color:#059669; font-weight:600;">Idle Time</h4>
                            <p id="idleTime" style="font-size:1.8rem; font-weight:700; color:#065f46; margin:10px 0 0 0;">-</p>
                        </div>
                        <div class="summary-card" style="background:#fef3c7; padding:20px; border-radius:12px; text-align:center;">
                            <h4 style="margin:0; font-size:0.9rem; color:#b45309; font-weight:600;">Avg CPU Load</h4>
                            <p id="avgCpuLoad" style="font-size:1.8rem; font-weight:700; color:#92400e; margin:10px 0 0 0;">-</p>
                        </div>
                        <div class="summary-card" style="background:#fee2e2; padding:20px; border-radius:12px; text-align:center;">
                            <h4 style="margin:0; font-size:0.9rem; color:#b91c1c; font-weight:600;">Avg Memory Usage</h4>
                            <p id="avgMemUsage" style="font-size:1.8rem; font-weight:700; color:#991b1b; margin:10px 0 0 0;">-</p>
                        </div>
                    </div>

                    <!-- Top Applications Chart (All PCs) -->
                    <div style="display:flex; flex-direction:column; gap:40px; margin-bottom:40px;">
                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08);">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;"> Top Applications by Usage (All PCs) </h4>
                            <div style="width:100%; height:320px; position:relative;">
                                <canvas id="analyticsAllPcChart"></canvas>
                            </div>
                        </div>

                        <!-- Donut Chart -->
                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08);">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;"> Application Usage Distribution (All PCs) </h4>
                            <div style="width:100%; height:320px; position:relative;">
                                <canvas id="allPcUsagePieChart"></canvas>
                            </div>
                        </div>

                        <!-- Bar Chart: Performance Metrics (All PCs) -->
                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08); margin-bottom:40px;">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;"> Performance Metrics Overview (All PCs) </h4>
                            <div style="width:100%; height:400px; position:relative;">
                                <canvas id="performanceMetricsChart"></canvas>
                            </div>
                        </div>

                        <!-- Scatter Plot: Resource Efficiency (All PCs) -->
                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08); margin-bottom:40px;">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;"> Resource Efficiency Comparison (All PCs) </h4>
                            <div style="width:100%; height:400px; position:relative;">
                                <canvas id="resourceEfficiencyChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Container (SECOND) -->
                    <div style="display:flex; flex-direction:column; gap:40px; margin-bottom:40px;">
                        <!-- Top Applications Chart -->
                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08);">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;">Top Applications by Usage</h4>
                            <div style="width:100%; height:320px; position:relative;">
                                <canvas id="analyticsAppChart"></canvas>
                            </div>
                        </div>

                        <!-- CPU Trend Chart -->
                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08);">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;">CPU Usage Trend (%)</h4>
                            <div style="width:100%; height:320px; position:relative;">
                                <canvas id="analyticsCpuChart"></canvas>
                            </div>
                        </div>

                        <!-- Memory Trend Chart -->
                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08);">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;">Memory Usage Trend (GB)</h4>
                            <div style="width:100%; height:320px; position:relative;">
                                <canvas id="analyticsMemChart"></canvas>
                            </div>
                        </div>

                        <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08); margin-bottom:40px;">
                            <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;"> Active vs Idle</h4>
                            <div style="width:100%; height:320px; position:relative;">
                                <canvas id="activeIdleChart" style="width:100%; height:280px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Resource Utilization Summary (AFTER CHARTS) -->
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:40px; padding:20px; background:#f0f9ff; border-radius:12px; border-left:4px solid #0284c7;">
                        <div style="text-align:center;">
                            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:#0c4a6e; font-weight:600; margin-bottom:8px;">Peak CPU Load</div>
                            <div id="peakCpuLoad" style="font-size:2.2rem; font-weight:700; color:#0369a1; margin-bottom:5px;">-</div>
                            <div style="font-size:0.85rem; color:#0c4a6e;">Maximum usage</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:#0c4a6e; font-weight:600; margin-bottom:8px;">Peak Memory</div>
                            <div id="peakMemory" style="font-size:2.2rem; font-weight:700; color:#0369a1; margin-bottom:5px;">-</div>
                            <div style="font-size:0.85rem; color:#0c4a6e;">Maximum usage</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:#0c4a6e; font-weight:600; margin-bottom:8px;">Total Sessions</div>
                            <div id="totalSessions" style="font-size:2.2rem; font-weight:700; color:#0369a1; margin-bottom:5px;">-</div>
                            <div style="font-size:0.85rem; color:#0c4a6e;">App sessions count</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:#0c4a6e; font-weight:600; margin-bottom:8px;">Avg Session Duration</div>
                            <div id="avgSessionDuration" style="font-size:2.2rem; font-weight:700; color:#0369a1; margin-bottom:5px;">-</div>
                            <div style="font-size:0.85rem; color:#0c4a6e;">Average per session</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:#0c4a6e; font-weight:600; margin-bottom:8px;">Avg CPU Usage</div>
                            <div id="avgCpuUsage" style="font-size:2.2rem; font-weight:700; color:#0369a1; margin-bottom:5px;">-</div>
                            <div style="font-size:0.85rem; color:#0c4a6e;">Average during active time</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:0.75rem; text-transform:uppercase; letter-spacing:1px; color:#0c4a6e; font-weight:600; margin-bottom:8px;">Resource Efficiency</div>
                            <div id="resourceEfficiency" style="font-size:2.2rem; font-weight:700; color:#0369a1; margin-bottom:5px;">-</div>
                            <div style="font-size:0.85rem; color:#0c4a6e;">Active/Idle ratio</div>
                        </div>
                    </div>

                    <!-- Top Memory Hogs Table (AFTER CHARTS) -->
                    <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08); margin-bottom:40px;">
                        <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;">Top Memory Consumers</h4>
                        <div style="overflow-x:auto;">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="background:linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color:white;">
                                        <th style="padding:15px; text-align:left; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Application</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Peak Memory</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Avg Memory</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Sessions</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="topMemoryHogsTable">
                                    <tr>
                                        <td colspan="5" style="padding:30px; text-align:center; color:#64748b;">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Top CPU Consumers Table (AFTER CHARTS) -->
                    <div style="background:white; padding:25px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.08); margin-bottom:40px;">
                        <h4 style="font-size:1rem; font-weight:700; margin:0 0 20px 0; color:#1f2937;">Top CPU Consumers</h4>
                        <div style="overflow-x:auto;">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead>
                                    <tr style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:white;">
                                        <th style="padding:15px; text-align:left; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Application</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Peak CPU</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Avg CPU</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Sessions</th>
                                        <th style="padding:15px; text-align:center; font-weight:600; font-size:0.9rem; text-transform:uppercase; letter-spacing:0.5px;">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="topCpuConsumersTable">
                                    <tr>
                                        <td colspan="5" style="padding:30px; text-align:center; color:#64748b;">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Summary Section (LAST) -->
                    <div style="background:#f3f4f6; padding:20px; border-radius:12px;">
                        <h4 style="font-size:1rem; font-weight:700; margin:0 0 12px 0; color:#1f2937;">Summary</h4>
                        <p id="analyticsSummary" style="color:#4b5563; line-height:1.6; margin:0;"></p>
                    </div>
                </div>
            </div>
        </div>


        <div id="loadingMessage" class="loading">
            Enter PC name and date to view activity data
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://uxhefdybgjluzkbodryd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4aGVmZHliZ2psdXprYm9kcnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDExMzAsImV4cCI6MjA3NjM3NzEzMH0.jvFSOUUNiWvLFdPHplVuRgvKkvt2zlet6NA_x3mLaJM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Set today's date as default
        document.getElementById('selectedDate').value = new Date().toISOString().split('T')[0];
        const analyticsDateInput = document.getElementById('analyticsCustomDate');
        if (analyticsDateInput) {
            analyticsDateInput.value = new Date().toISOString().split('T')[0];
        }
        handleAnalyticsRangeChange();

        let appChart = null;
        let cpuChart = null;
        let memoryChart = null;
        let taskManagerRefreshInterval = null;
        let autoRefreshInterval = null;
        let pcStatusRefreshInterval = null;
        let lastUpdateTime = null;
        const PC_STATUS_REFRESH_INTERVAL = 5000; // 5 seconds for PC status
        const FULL_REFRESH_INTERVAL = 20000; // 20 seconds for full data reload
        const TASK_MANAGER_REFRESH_INTERVAL = 3000; // 3 seconds for task manager
        
        // Pagination variables
        let allAppData = [];
        let currentPage = 1;
        const itemsPerPage = 10; // Show 10 items per page

        // Auto-refresh functionality
        // PC status updates every 5 seconds, full data reload every 20 seconds
        function startAutoRefresh() {
            // Clear any existing intervals
            stopAutoRefresh();
            
            const pcName = document.getElementById('pcName').value.trim();
            if (!pcName) {
                return; // Don't start if no PC name
            }
            
            // Show indicator immediately (if it exists)
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.style.display = 'inline-flex';
            }
            updateLastUpdateTime();
            
            // Start PC status refresh interval (every 5 seconds)
            pcStatusRefreshInterval = setInterval(() => {
                const currentPcName = document.getElementById('pcName').value.trim();
                if (currentPcName) {
                    console.log('Auto-refresh: Updating PC status...');
                    refreshPcStatusOnly(currentPcName);
                } else {
                    stopAutoRefresh();
                }
            }, PC_STATUS_REFRESH_INTERVAL);
            
            // Start full data refresh interval (every 20 seconds)
            // Skip full reload if task manager is open
            autoRefreshInterval = setInterval(() => {
                const currentPcName = document.getElementById('pcName').value.trim();
                if (currentPcName) {
                    // Check if task manager is open
                    const taskManagerSection = document.getElementById('taskManagerSection');
                    const isTaskManagerOpen = taskManagerSection && taskManagerSection.style.display !== 'none';
                    
                    if (!isTaskManagerOpen) {
                        console.log('Auto-refresh: Full data reload...');
                        loadData();
                    } else {
                        console.log('Auto-refresh: Skipping full reload (task manager is open)');
                    }
                } else {
                    stopAutoRefresh();
                }
            }, FULL_REFRESH_INTERVAL);
            
            console.log('Auto-refresh started for PC:', pcName, '- PC status: 5s, Full reload: 20s');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            if (pcStatusRefreshInterval) {
                clearInterval(pcStatusRefreshInterval);
                pcStatusRefreshInterval = null;
            }
            console.log('Auto-refresh stopped');
            const refreshIndicator = document.getElementById('refreshIndicator');
            if (refreshIndicator) {
                refreshIndicator.style.display = 'none';
            }
        }

        // Refresh only PC status (faster, every 5 seconds)
        async function refreshPcStatusOnly(pcName) {
            try {
                // Fetch PC status
                let isOnline = false;
                let statusData = null;
                try {
                    const { data: statusDataResult, error: statusError } = await supabase
                        .from('pc_status')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!statusError && statusDataResult) {
                        statusData = statusDataResult;
                        isOnline = statusData.is_online || false;
                    }
                } catch (err) {
                    console.warn('Could not fetch PC status:', err);
                }

                // Fetch system info
                let systemInfo = null;
                try {
                    const { data: systemInfoData, error: systemInfoError } = await supabase
                        .from('system_info')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!systemInfoError && systemInfoData) {
                        systemInfo = systemInfoData;
                    }
                } catch (err) {
                    console.warn('Could not fetch system info:', err);
                }

                // Get selected date
                // Update PC status only
                const selectedDate = document.getElementById('selectedDate').value || new Date().toISOString().split('T')[0];
                updatePcStatus(pcName, isOnline, statusData, systemInfo, selectedDate);
                
                // Update last update time
                updateLastUpdateTime();
            } catch (error) {
                console.error('Error refreshing PC status:', error);
            }
        }

            function updateLastUpdateTime() {
            // Always use the browser's actual local time (no manual offset math)
            const now = new Date();

            const dateStr = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true 
            });

            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = `Last updated: ${dateStr}  ${timeStr}`;
            }
            }




        function handleAnalyticsRangeChange() {
            const rangeSelect = document.getElementById('analyticsRangeSelect');
            const customGroup = document.getElementById('analyticsCustomDateGroup');
            const customInput = document.getElementById('analyticsCustomDate');
            if (!rangeSelect || !customGroup || !customInput) return;
            const isCustom = rangeSelect.value === 'custom';
            customGroup.style.display = isCustom ? 'block' : 'none';
            customInput.disabled = !isCustom;
            if (isCustom && !customInput.value) {
                customInput.value = new Date().toISOString().split('T')[0];
            }
        }

        function getAnalyticsRangeConfig() {
            const rangeSelect = document.getElementById('analyticsRangeSelect');
            const customInput = document.getElementById('analyticsCustomDate');
            const mode = rangeSelect ? rangeSelect.value : 'today';
            const today = new Date();
            const todayIso = today.toISOString().split('T')[0];

            const buildSingleDay = (dateStr, label) => ({
                mode: 'single',
                startIso: `${dateStr}T00:00:00`,
                endIso: `${dateStr}T23:59:59`,
                label,
                selectedDate: dateStr
            });

            if (mode === 'custom') {
                const customDate = customInput && customInput.value ? customInput.value : todayIso;
                if (customInput && !customInput.value) {
                    customInput.value = customDate;
                }
                return buildSingleDay(customDate, customDate);
            }

            if (mode === 'today') {
                return buildSingleDay(todayIso, 'Today');
            }

            const dayCounts = { last3: 3, last5: 5, last30: 30 };
            const days = dayCounts[mode] || 3;
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - (days - 1));
            startDate.setHours(0, 0, 0, 0);

            return {
                mode,
                startIso: startDate.toISOString(),
                endIso: endDate.toISOString(),
                label: `Last ${days} days`
            };
        }

        function computeActiveIdleFromEntries(entries, rangeStartMs, rangeEndMs) {
            const totalRangeMs = Math.max(0, rangeEndMs - rangeStartMs);
            if (!entries || !entries.length || totalRangeMs === 0) {
                return { activeSeconds: 0, idleSeconds: totalRangeMs / 1000 };
            }

            const intervals = entries.map(entry => {
                const startRaw = entry.start_time || entry.startTime || entry.start;
                const endRaw = entry.end_time || entry.endTime || entry.end;
                let start = startRaw ? new Date(startRaw).getTime() : NaN;
                let end = endRaw ? new Date(endRaw).getTime() : NaN;

                if (isNaN(start) && !isNaN(end) && entry.duration_seconds) {
                    start = end - Number(entry.duration_seconds) * 1000;
                }
                if (isNaN(end) && !isNaN(start) && entry.duration_seconds) {
                    end = start + Number(entry.duration_seconds) * 1000;
                }

                if (isNaN(start) || isNaN(end)) {
                    return null;
                }

                const clampedStart = Math.max(rangeStartMs, start);
                const clampedEnd = Math.min(rangeEndMs, end);

                if (clampedEnd <= clampedStart) {
                    return null;
                }

                return [clampedStart, clampedEnd];
            }).filter(Boolean);

            if (!intervals.length) {
                return { activeSeconds: 0, idleSeconds: totalRangeMs / 1000 };
            }

            intervals.sort((a, b) => a[0] - b[0]);
            const merged = [];
            for (const interval of intervals) {
                if (!merged.length) {
                    merged.push(interval.slice());
                    continue;
                }
                const last = merged[merged.length - 1];
                if (interval[0] <= last[1]) {
                    last[1] = Math.max(last[1], interval[1]);
                } else {
                    merged.push(interval.slice());
                }
            }

            const activeMs = merged.reduce((sum, [start, end]) => sum + (end - start), 0);
            const idleMs = Math.max(0, totalRangeMs - activeMs);

            return {
                activeSeconds: activeMs / 1000,
                idleSeconds: idleMs / 1000
            };
        }

        // Get URL parameters
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                pc: params.get('pc') || '',
                date: params.get('date') || ''
            };
        }

        // Update URL without reloading page
        function updateURL(pcName, date) {
            const url = new URL(window.location);
            if (pcName) {
                url.searchParams.set('pc', pcName);
            }
            if (date) {
                url.searchParams.set('date', date);
            } else {
                url.searchParams.delete('date');
            }
            window.history.pushState({}, '', url);
        }

        // Check for URL parameters on page load
        function checkURLParams() {
            const params = getURLParams();
            if (params.date) {
                document.getElementById('selectedDate').value = params.date;
            }

            if (params.pc) {
                document.getElementById('pcName').value = params.pc;
                // Auto-load data
                loadData();
            }
        }

        // Page navigation
        const PAGE_MAP = {
            home: 'homePage',
            detail: 'detailPage',
            analytics: 'analyticsPage'
        };

        function setActivePage(page) {
            Object.entries(PAGE_MAP).forEach(([key, id]) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (key === page) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });

            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                const target = btn.getAttribute('data-page');
                btn.classList.toggle('active', target === page);
            });
        }

        function showHomePage(event) {
            setActivePage('home');
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            stopAutoRefresh();
            loadAllPCs();
        }

        function showDetailPage(event) {
            setActivePage('detail');
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            const pcName = document.getElementById('pcName').value.trim();
            if (pcName) {
                startAutoRefresh();
            }
        }

        function showAnalyticsPage(event) {
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            setActivePage('analytics');
            stopAutoRefresh();
        }

        function navigateToPC(pcName) {
            document.getElementById('pcName').value = pcName;
            showDetailPage();
            loadData();
        }

        // Load all PCs for home page
        async function loadAllPCs() {
            const pcsGrid = document.getElementById('pcsGrid');
            pcsGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading PCs...</div>';

            try {
                // Fetch all PC statuses
                const { data: pcStatuses, error: statusError } = await supabase
                    .from('pc_status')
                    .select('*')
                    .order('pc_name', { ascending: true });

                if (statusError) {
                    console.warn('Could not fetch PC statuses:', statusError);
                }

                // Fetch all system info
                const { data: systemInfos, error: systemError } = await supabase
                    .from('system_info')
                    .select('*')
                    .order('pc_name', { ascending: true });

                if (systemError) {
                    console.warn('Could not fetch system info:', systemError);
                }

                // Combine data
                const pcsMap = new Map();
                
                // Add PC statuses
                if (pcStatuses) {
                    pcStatuses.forEach(pc => {
                        pcsMap.set(pc.pc_name, {
                            pc_name: pc.pc_name,
                            is_online: pc.is_online || false,
                            last_seen: pc.last_seen,
                            last_activity: pc.last_activity,
                            systemInfo: null
                        });
                    });
                }

                // Add system info
                if (systemInfos) {
                    systemInfos.forEach(info => {
                        if (pcsMap.has(info.pc_name)) {
                            pcsMap.get(info.pc_name).systemInfo = info;
                        } else {
                            pcsMap.set(info.pc_name, {
                                pc_name: info.pc_name,
                                is_online: false,
                                last_seen: null,
                                last_activity: null,
                                systemInfo: info
                            });
                        }
                    });
                }

                // Display PCs
                if (pcsMap.size === 0) {
                    pcsGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-desktop"></i>
                            <h3>No PCs Found</h3>
                            <p>No PCs have been registered yet. Start the client application on a PC to register it.</p>
                        </div>
                    `;
                    return;
                }

                const pcsArray = Array.from(pcsMap.values());
                pcsGrid.innerHTML = pcsArray.map(pc => {
                    const isOnline = pc.is_online;
                    const statusClass = isOnline ? '' : 'offline';
                    const statusText = isOnline ? 'Online' : 'Offline';
                    
                    return `
                        <div class="pc-card" onclick="navigateToPC('${escapeHtml(pc.pc_name)}')">
                            <div class="pc-card-header">
                                <div class="pc-card-status ${statusClass}"></div>
                                <div class="pc-card-name">${escapeHtml(pc.pc_name)}</div>
                            </div>
                            <div class="pc-card-info">
                                <div class="pc-card-info-item">
                                    <span>Status:</span>
                                    <span style="color: ${isOnline ? '#22c55e' : '#ef4444'}; font-weight: 600;">${statusText}</span>
                                </div>
                                ${pc.systemInfo && pc.systemInfo.cpu_model ? `
                                    <div class="pc-card-info-item">
                                        <span>CPU:</span>
                                        <span>${escapeHtml(pc.systemInfo.cpu_model)}</span>
                                    </div>
                                ` : ''}
                                ${pc.systemInfo && pc.systemInfo.total_memory_gb ? `
                                    <div class="pc-card-info-item">
                                        <span>RAM:</span>
                                        <span>${pc.systemInfo.total_memory_gb} GB</span>
                                    </div>
                                ` : ''}
                                ${pc.last_seen ? `
                                    <div class="pc-card-info-item">
                                        <span>Last Seen:</span>
                                        <span>${formatDateTime(pc.last_seen)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading PCs:', error);
                pcsGrid.innerHTML = `
                    <div class="error" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading PCs. Please check your connection and try again.
                    </div>
                `;
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            const params = getURLParams();
            if (params.pc) {
                // If URL has PC parameter, show detail page
                showDetailPage();
                checkURLParams();
            } else {
                // Otherwise show home page
                loadAllPCs();
            }
        });

        // Stop auto-refresh when page is hidden (tab switch)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                const pcName = document.getElementById('pcName').value.trim();
                if (pcName) {
                    startAutoRefresh();
                }
            }
        });

        async function loadData() {
            const pcName = document.getElementById('pcName').value.trim();
            const selectedDate = document.getElementById('selectedDate').value || new Date().toISOString().split('T')[0];

            if (!pcName) {
                alert('Please enter a PC name');
                return;
            }

            // Update URL with current parameters
            updateURL(pcName, selectedDate);

            // Update header and show loading state
            const headerText = document.getElementById('headerText');
            if (headerText) {
                headerText.textContent = `PC: ${pcName}  ${selectedDate}`;
            } else {
                document.getElementById('headerSubtitle').textContent = `PC: ${pcName}  ${selectedDate}`;
            }
            document.getElementById('loadingMessage').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading data...';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('statsGrid').style.display = 'none';
            document.getElementById('pcStatusContainer').style.display = 'none';
            document.getElementById('apps-tab').style.display = 'none';
            
            // HIDE analytics section when loading data
            const analyticsSection = document.getElementById('analyticsSection');
            if (analyticsSection) {
                analyticsSection.style.display = 'none';
            }
            
            
            hideTaskManager();

            try {
                // Fetch PC status (handle case where table might not exist)
                let isOnline = false;
                let statusData = null;
                try {
                    const { data: statusDataResult, error: statusError } = await supabase
                        .from('pc_status')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!statusError && statusDataResult) {
                        statusData = statusDataResult;
                        isOnline = statusData.is_online || false;
                    }
                } catch (err) {
                    // Table might not exist, use default offline status
                    console.warn('Could not fetch PC status:', err);
                }

                // Fetch system info
                let systemInfo = null;
                try {
                    const { data: systemInfoData, error: systemInfoError } = await supabase
                        .from('system_info')
                        .select('*')
                        .eq('pc_name', pcName)
                        .single();

                    if (!systemInfoError && systemInfoData) {
                        systemInfo = systemInfoData;
                    }
                } catch (err) {
                    console.warn('Could not fetch system info:', err);
                }

                updatePcStatus(pcName, isOnline, statusData, systemInfo, selectedDate);

                // Fetch app usage data
                const { data: appData, error: appError } = await supabase
                    .from('app_usage_logs')
                    .select('*')
                    .eq('pc_name', pcName)
                    .gte('start_time', `${selectedDate}T00:00:00`)
                    .lte('end_time', `${selectedDate}T23:59:59`)
                    .order('start_time', { ascending: false });

                if (appError) {
                    console.error('App data error:', appError);
                    throw appError;
                }

                // Process and display data
                processData(appData || []);

                // Update last update time
                updateLastUpdateTime();

                // Start auto-refresh (will reload data every 5 seconds)
                // Only start if not already running (to avoid multiple intervals)
                if (!autoRefreshInterval) {
                    startAutoRefresh();
                }

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading data. Please check your connection and try again.
                    </div>`;
            }
        }

                function processData(appData) {
            console.log('Processing data:', appData.length, 'entries');
            
            // Make sure analytics is hidden
            const analyticsSection = document.getElementById('analyticsSection');
            if (analyticsSection) {
                analyticsSection.style.display = 'none';
            }
            
            // Calculate stats
            const totalAppSessions = appData.length;
            const totalAppTime = appData.reduce((sum, row) => sum + (row.duration_seconds || 0), 0);

            // Update stats grid
            const statsGrid = document.getElementById('statsGrid');
            if (statsGrid) {
                statsGrid.innerHTML = `
                    <div class="stat-card" id="appSessionsCard" onclick="toggleAppSessionsBreakdown()" style="cursor: pointer;">
                        <i class="fas fa-desktop"></i>
                        <div class="number">${totalAppSessions}</div>
                        <div class="label">App Sessions</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock"></i>
                        <div class="number">${formatDuration(totalAppTime)}</div>
                        <div class="label">Total Usage</div>
                    </div>
                    <div id="appSessionsBreakdown" style="grid-column: 1 / -1; display: none; margin-top: 10px;">
                        <!-- Breakdown content injected here -->
                    </div>
                `;
                statsGrid.style.display = 'grid';
            }

            // Populate tables
            populateAppTable(appData);

            // Create/update charts
            createAppChart(appData);

            // Hide loading message
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.style.display = 'none';
            }
            
            // SHOW apps-tab with all content
            const appsTab = document.getElementById('apps-tab');
            if (appsTab) {
                appsTab.style.display = 'block';
            }

            // EXPLICITLY SHOW chart container and data table
            const chartContainer = appsTab ? appsTab.querySelector('.chart-container') : null;
            const dataTable = appsTab ? appsTab.querySelector('.data-table') : null;

            if (chartContainer) {
                chartContainer.style.display = 'block';
            }
            if (dataTable) {
                dataTable.style.display = 'block';
            }

            // SHOW pagination controls
            const paginationControls = document.getElementById('paginationControls');
            if (paginationControls) {
                paginationControls.style.display = 'flex';
            }
            
            console.log('Data processed and displayed');
        }

        function toggleAppSessionsBreakdown() {
            const breakdownEl = document.getElementById('appSessionsBreakdown');
            if (!breakdownEl) return;
            if (breakdownEl.style.display === 'none' || breakdownEl.style.display === '') {
                // Build breakdown content
                const counts = computeAppSessionCounts();
                if (counts.length === 0) {
                    breakdownEl.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-info-circle"></i>
                            <h3>No sessions to summarize</h3>
                        </div>
                    `;
                } else {
                    const total = counts.reduce((s, c) => s + c.count, 0);
                    breakdownEl.innerHTML = `
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Application</th>
                                        <th>Sessions</th>
                                        <th>Share</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${counts.map(({ name, count }) => {
                                        const pct = total ? Math.round((count / total) * 100) : 0;
                                        return `
                                            <tr>
                                                <td>${escapeHtml(name)}</td>
                                                <td>${count}</td>
                                                <td>${pct}%</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                breakdownEl.style.display = 'block';
            } else {
                breakdownEl.style.display = 'none';
            }
        }

        function computeAppSessionCounts() {
            try {
                const map = new Map();
                (allAppData || []).forEach(entry => {
                    const name = entry && entry.app_name ? String(entry.app_name) : 'Unknown';
                    map.set(name, (map.get(name) || 0) + 1);
                });
                // Sort by count desc, then name asc
                return Array.from(map.entries())
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));
            } catch {
                return [];
            }
        }

        function populateAppTable(appData) {
            const tbody = document.getElementById('appTableBody');
            const paginationControls = document.getElementById('paginationControls');

            // Store all data for pagination
            allAppData = appData;
            currentPage = 1;

            if (appData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-desktop"></i>
                            <h3>No App Usage Data</h3>
                            <p>No application usage recorded for this date</p>
                        </td>
                    </tr>`;
                paginationControls.style.display = 'none';
                return;
            }

            // Show pagination if more than itemsPerPage
            if (appData.length > itemsPerPage) {
                paginationControls.style.display = 'flex';
                updatePagination();
            } else {
                paginationControls.style.display = 'none';
            }

            // Display current page
            displayCurrentPage();
        }

        function displayCurrentPage() {
            const tbody = document.getElementById('appTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = allAppData.slice(startIndex, endIndex);

            tbody.innerHTML = pageData.map(entry => {
                const duration = formatDuration(entry.duration_seconds || 0);
                const memory = entry.memory_usage_bytes ? formatBytes(entry.memory_usage_bytes) : 'N/A';
                const cpu = entry.cpu_percent ? `${Math.round(entry.cpu_percent)}%` : 'N/A';

                return `
                    <tr>
                        <td>${escapeHtml(entry.app_name)}</td>
                        <td>${formatTime(entry.start_time)}</td>
                        <td>${formatTime(entry.end_time)}</td>
                        <td>${duration}</td>
                        <td>${memory}</td>
                        <td>${cpu}</td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(allAppData.length / itemsPerPage);
            const paginationInfo = document.getElementById('paginationInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbers = document.getElementById('pageNumbers');

            // Update info
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, allAppData.length);
            paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${allAppData.length}`;

            // Update buttons
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;

            // Update page numbers
            pageNumbers.innerHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.className = 'page-number';
                firstBtn.textContent = '1';
                firstBtn.onclick = () => goToPage(1);
                pageNumbers.appendChild(firstBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 5px';
                    pageNumbers.appendChild(ellipsis);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'page-number' + (i === currentPage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageNumbers.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 5px';
                    pageNumbers.appendChild(ellipsis);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.className = 'page-number';
                lastBtn.textContent = totalPages;
                lastBtn.onclick = () => goToPage(totalPages);
                pageNumbers.appendChild(lastBtn);
            }
        }

        function changePage(direction) {
            const totalPages = Math.ceil(allAppData.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayCurrentPage();
                // Scroll to top of table
                document.getElementById('appTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function goToPage(page) {
            const totalPages = Math.ceil(allAppData.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayCurrentPage();
                // Scroll to top of table
                document.getElementById('appTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }


        function createAppChart(appData) {
            const chartCanvas = document.getElementById('appUsageChart');
            if (!chartCanvas) {
                console.warn('Chart canvas not found');
                return;
            }

            const ctx = chartCanvas.getContext('2d');
            const appUsage = {};

            appData.forEach(entry => {
                if (entry && entry.app_name) {
                    if (!appUsage[entry.app_name]) {
                        appUsage[entry.app_name] = 0;
                    }
                    appUsage[entry.app_name] += entry.duration_seconds || 0;
                }
            });

            // Destroy existing chart if it exists
            if (appChart) {
                appChart.destroy();
                appChart = null;
            }

            // Create new chart
            const labels = Object.keys(appUsage);
            const data = Object.values(appUsage).map(seconds => Math.round(seconds / 60));

            if (labels.length === 0) {
                console.log('No app data to display in chart');
                return;
            }

            appChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Usage Time (minutes)',
                        data: data,
                        backgroundColor: '#4f46e5'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    animation: {
                        duration: 300
                    }
                }
            });

            console.log('Chart updated with', labels.length, 'apps');
        }

        // Active vs Idle chart
function createActiveIdleChart(activeMinutes, idleMinutes) {
    const ctx = document.getElementById('activeIdleChart').getContext('2d');

    if (window.activeIdleChart && typeof window.activeIdleChart.destroy === 'function') {
  window.activeIdleChart.destroy();
}


    window.activeIdleChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Time Breakdown'],
            datasets: [
                {
                    label: 'Active Time',
                    data: [activeMinutes],
                    backgroundColor: '#10b981'
                },
                {
                    label: 'Idle Time',
                    data: [idleMinutes],
                    backgroundColor: '#ef4444'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y} min`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Minutes',
                        font: { size: 12, weight: 'bold' }
                    }
                }
            }
        }
    });
}



        function updatePcStatus(pcName, isOnline, statusData, systemInfo, selectedDate) {
            const statusIndicator = document.getElementById('statusIndicator');
            const pcDisplayName = document.getElementById('pcDisplayName');
            const pcStatusText = document.getElementById('pcStatusText');
            const systemInfoGrid = document.getElementById('systemInfoGrid');
            const pcStatusContainer = document.getElementById('pcStatusContainer');

            // Make sure the container is visible
            if (pcStatusContainer) {
                pcStatusContainer.style.display = 'block';
            }

            if (!pcDisplayName || !pcStatusText || !statusIndicator) {
                console.error('PC status elements not found');
                return;
            }

            pcDisplayName.textContent = pcName;
            
            const statusIcon = isOnline ? 'fa-check-circle' : 'fa-times-circle';
            const statusLabel = isOnline ? 'Online' : 'Offline';
            const statusColor = isOnline ? '#22c55e' : '#ef4444';
            
            pcStatusText.innerHTML = `
                <i class="fas ${statusIcon}" style="color: ${statusColor}"></i>
                <span>${statusLabel}</span>
            `;

            if (isOnline) {
                statusIndicator.classList.remove('offline');
            } else {
                statusIndicator.classList.add('offline');
            }

            console.log('PC Status updated:', { pcName, isOnline, hasStatusData: !!statusData, hasSystemInfo: !!systemInfo });

            // Display system info
            if (systemInfo) {
                systemInfoGrid.innerHTML = `
                    ${systemInfo.cpu_model ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-microchip"></i> CPU</div>
                            <div class="value">${escapeHtml(systemInfo.cpu_model)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.cpu_cores ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-layer-group"></i> Cores</div>
                            <div class="value">${systemInfo.cpu_cores}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.cpu_speed_ghz ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-tachometer-alt"></i> CPU Speed</div>
                            <div class="value">${systemInfo.cpu_speed_ghz} GHz</div>
                        </div>
                    ` : ''}
                    ${systemInfo.total_memory_gb ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-memory"></i> RAM</div>
                            <div class="value">${systemInfo.total_memory_gb} GB</div>
                        </div>
                    ` : ''}
                    ${systemInfo.os_platform ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-desktop"></i> OS</div>
                            <div class="value">${escapeHtml(systemInfo.os_platform)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.os_version ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-code-branch"></i> OS Version</div>
                            <div class="value">${escapeHtml(systemInfo.os_version)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.hostname ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-network-wired"></i> Hostname</div>
                            <div class="value">${escapeHtml(systemInfo.hostname)}</div>
                        </div>
                    ` : ''}
                    ${statusData && statusData.last_seen ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-clock"></i> Last Seen</div>
                            <div class="value">${formatDateTime(statusData.last_seen)}</div>
                        </div>
                    ` : ''}
                `;
            } else {
                // Show basic info if system_info not available
                systemInfoGrid.innerHTML = `
                    ${statusData && statusData.last_seen ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-clock"></i> Last Seen</div>
                            <div class="value">${formatDateTime(statusData.last_seen)}</div>
                        </div>
                    ` : ''}
                    ${!systemInfo ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-info-circle"></i> System Info</div>
                            <div class="value">Not Available</div>
                        </div>
                    ` : ''}
                `;
            }

            document.getElementById('pcStatusContainer').style.display = 'block';
            
            // Update shareable link (use the selectedDate from the function parameter)
            updateShareableLink(pcName, selectedDate);
        }

        function updateShareableLink(pcName, date) {
            // Use current page URL
            const currentURL = window.location.origin + window.location.pathname;
            const url = new URL(currentURL);
            url.searchParams.set('pc', pcName);
            if (date) {
                url.searchParams.set('date', date);
            } else {
                url.searchParams.delete('date');
            }
            const shareableLink = document.getElementById('shareableLink');
            if (shareableLink) {
                shareableLink.value = url.toString();
            }
        }

        function copyLink(event) {
            const linkInput = document.getElementById('shareableLink');
            if (!linkInput.value) return;
            
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices
            
            const copyToClipboard = () => {
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(linkInput.value).then(() => {
                            showCopyFeedback(event);
                        }).catch(() => {
                            // Fallback to execCommand
                            document.execCommand('copy');
                            showCopyFeedback(event);
                        });
                    } else {
                        // Fallback for older browsers
                        document.execCommand('copy');
                        showCopyFeedback(event);
                    }
                } catch (err) {
                    console.error('Failed to copy:', err);
                }
            };
            
            copyToClipboard();
        }

        function showCopyFeedback(event) {
            const button = event ? event.target.closest('button') : document.querySelector('button[onclick="copyLink()"]');
            if (!button) return;
            
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check"></i> Copied!';
            button.style.background = '#22c55e';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.style.background = '#4f46e5';
            }, 2000);
        }


        function formatTime(timeString) {
            if (!timeString) return 'N/A';
            try {
                let date;
                
                // Handle Date object
                if (timeString instanceof Date) {
                    date = timeString;
                } else if (typeof timeString === 'number') {
                    // Unix ms timestamp
                    date = new Date(timeString);
                } else if (typeof timeString === 'string') {
                    // ISO with explicit timezone (Z or +/-offset)
                    if (timeString.includes('T') && (timeString.includes('Z') || /[+-]\d{2}:\d{2}$/.test(timeString))) {
                        date = new Date(timeString);
                    }
                    // Legacy format: "YYYY-MM-DD HH:MM AM/PM"
                    else if (timeString.includes('AM') || timeString.includes('PM')) {
                        const parts = timeString.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})\s+(AM|PM)/);
                        if (parts) {
                            let year = parseInt(parts[1]);
                            let month = parseInt(parts[2]) - 1;
                            let day = parseInt(parts[3]);
                            let hour = parseInt(parts[4]);
                            let minute = parseInt(parts[5]);
                            const ampm = parts[6];
                            if (ampm === 'PM' && hour !== 12) hour += 12;
                            if (ampm === 'AM' && hour === 12) hour = 0;
                            date = new Date(year, month, day, hour, minute);
                        } else {
                            date = new Date(timeString);
                        }
                    }
                    // ISO-like without explicit timezone
                    else if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(timeString)) {
                        // Treat ISO-like without timezone as UTC to avoid browser local misinterpretation
                        date = new Date(timeString.endsWith('Z') ? timeString : timeString + 'Z');
                    } else {
                        date = new Date(timeString);
                    }
                }

                if (!date || isNaN(date.getTime())) {
                    return timeString;
                }

                return date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true,
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                });
            } catch (e) {
                return timeString;
            }
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return 'N/A';
            try {
                // Normalize incoming string
                if (typeof dateTimeString === 'string') {
                    // Trim whitespace
                    dateTimeString = dateTimeString.trim();
                    // Pad fractional seconds to 3 digits if only 1-2 are present (e.g., .57 -> .570)
                    dateTimeString = dateTimeString.replace(/(T\d{2}:\d{2}:\d{2})\.(\d{1,2})(?=(Z|[+-]\d{2}:\d{2}))/,
                        (m, t, frac, tz) => `${t}.${frac.padEnd(3, '0')}${tz}`);
                }
                let date;
                
                // Check if it's an ISO string (new format from server)
                if (typeof dateTimeString === 'string' && dateTimeString.includes('T') && dateTimeString.includes('Z')) {
                    // ISO string with timezone - parse directly
                    date = new Date(dateTimeString);
                }
                // Handle legacy format: "YYYY-MM-DD HH:MM AM/PM" (old format)
                else if (typeof dateTimeString === 'string' && (dateTimeString.includes('AM') || dateTimeString.includes('PM'))) {
                    // Parse the custom format: "2025-11-09 09:23 PM"
                    const parts = dateTimeString.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})\s+(AM|PM)/);
                    if (parts) {
                        let year = parseInt(parts[1]);
                        let month = parseInt(parts[2]) - 1; // Month is 0-indexed
                        let day = parseInt(parts[3]);
                        let hour = parseInt(parts[4]);
                        let minute = parseInt(parts[5]);
                        let ampm = parts[6];
                        
                        // Convert to 24-hour format
                        if (ampm === 'PM' && hour !== 12) {
                            hour += 12;
                        } else if (ampm === 'AM' && hour === 12) {
                            hour = 0;
                        }
                        
                        // Create date in local timezone (not UTC)
                        date = new Date(year, month, day, hour, minute);
                    } else {
                        // Fallback to standard Date parsing
                        date = new Date(dateTimeString);
                    }
                } else {
                    // Standard ISO date string (without Z) or other format
                    // If it looks like an ISO string without timezone, treat as UTC
                    if (typeof dateTimeString === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(dateTimeString)) {
                        // If it already has an explicit timezone offset like +08:00 or -05:00, keep it
                        if (/[+-]\d{2}:\d{2}$/.test(dateTimeString)) {
                            date = new Date(dateTimeString);
                        } else {
                            // No timezone info: treat as UTC
                            date = new Date(dateTimeString.endsWith('Z') ? dateTimeString : dateTimeString + 'Z');
                        }
                    } else {
                        date = new Date(dateTimeString);
                    }
                }
                
                if (isNaN(date.getTime())) {
                    // If still invalid, return as-is
                    return dateTimeString;
                }
                
                // Format using local timezone (browser's timezone)
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true,
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                });
            } catch (e) {
                console.error('Error formatting date:', dateTimeString, e);
                return dateTimeString;
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '0m';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${minutes}m`;
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const mb = bytes / (1024 * 1024);
            return `${Math.round(mb * 10) / 10} MB`;
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Task Manager Functions - Fetch from Supabase
        async function loadTaskManagerData(pcName) {
            if (!pcName) return;

            try {
                // Get recent app usage logs from the last 60 seconds
                const now = new Date();
                const sixtySecondsAgo = new Date(now.getTime() - 60000);
                
                const { data: logs, error } = await supabase
                    .from('app_usage_logs')
                    .select('cpu_percent, memory_usage_bytes, end_time')
                    .eq('pc_name', pcName)
                    .gte('end_time', sixtySecondsAgo.toISOString())
                    .order('end_time', { ascending: true })
                    .limit(100);

                if (error) {
                    throw error;
                }

                // Get system info
                const { data: systemInfo } = await supabase
                    .from('system_info')
                    .select('*')
                    .eq('pc_name', pcName)
                    .single();

                // Get latest stats
                const { data: latestLog } = await supabase
                    .from('app_usage_logs')
                    .select('cpu_percent, memory_usage_bytes')
                    .eq('pc_name', pcName)
                    .order('end_time', { ascending: false })
                    .limit(1)
                    .single();

                // Format data for charts
                const cpuData = (logs || []).map(log => ({
                    time: new Date(log.end_time).getTime(),
                    value: parseFloat(log.cpu_percent) || 0
                }));

                const memoryData = (logs || []).map(log => ({
                    time: new Date(log.end_time).getTime(),
                    value: parseInt(log.memory_usage_bytes) || 0
                }));

                const data = {
                    cpu: cpuData,
                    memory: memoryData,
                    lastUpdate: Date.now(),
                    systemInfo: systemInfo,
                    latestStats: latestLog ? {
                        cpuPercent: latestLog.cpu_percent,
                        memoryBytes: latestLog.memory_usage_bytes
                    } : null
                };

                updateTaskManager(data, pcName);
            } catch (error) {
                console.error('Error loading task manager data:', error);
                // Show error state
                const cpuUtilEl = document.getElementById('cpuUtilization');
                const cpuSpeedEl = document.getElementById('cpuSpeed');
                if (cpuUtilEl) cpuUtilEl.textContent = 'Error';
                if (cpuSpeedEl) cpuSpeedEl.textContent = 'Error';
            }
        }

        function updateTaskManager(data, pcName) {
            // Update CPU chart
            if (data.cpu && data.cpu.length > 0) {
                updateCPUChart(data.cpu);
                const latestCpu = data.cpu[data.cpu.length - 1];
                document.getElementById('cpuUtilization').textContent = `${latestCpu.value.toFixed(1)}%`;
            }

            // Update Memory chart
            if (data.memory && data.memory.length > 0) {
                updateMemoryChart(data.memory, data.systemInfo);
                const latestMemory = data.memory[data.memory.length - 1];
                const memoryGB = (latestMemory.value / (1024 * 1024 * 1024)).toFixed(2);
                const totalMemoryGB = data.systemInfo ? data.systemInfo.total_memory_gb : null;
                if (totalMemoryGB) {
                    const availableGB = (totalMemoryGB - parseFloat(memoryGB)).toFixed(2);
                    document.getElementById('memoryInUse').textContent = `${memoryGB} GB`;
                    document.getElementById('memoryAvailable').textContent = `${availableGB} GB`;
                }
            }

            // Update system info
            if (data.systemInfo) {
                const info = data.systemInfo;
                if (info.cpu_model) {
                    document.getElementById('cpuModel').textContent = info.cpu_model;
                }
                if (info.cpu_speed_ghz) {
                    document.getElementById('baseSpeed').textContent = `${info.cpu_speed_ghz.toFixed(2)} GHz`;
                    // Use latest stats for current speed if available
                    if (data.latestStats && data.latestStats.cpuPercent) {
                        // Estimate current speed based on utilization (rough estimate)
                        const estimatedSpeed = info.cpu_speed_ghz * (1 + (data.latestStats.cpuPercent / 100) * 0.1);
                        document.getElementById('cpuSpeed').textContent = `${estimatedSpeed.toFixed(2)} GHz`;
                    } else {
                        document.getElementById('cpuSpeed').textContent = `${info.cpu_speed_ghz.toFixed(2)} GHz`;
                    }
                }
                if (info.cpu_cores) {
                    document.getElementById('cores').textContent = info.cpu_cores;
                    document.getElementById('logicalProcessors').textContent = info.cpu_cores * 2; // Estimate
                }
                document.getElementById('sockets').textContent = '1';
                document.getElementById('virtualization').textContent = 'Enabled';
                document.getElementById('l1Cache').textContent = '128 KB';
                document.getElementById('l2Cache').textContent = '512 KB';
                document.getElementById('l3Cache').textContent = '4.0 MB';
            }

            // Update stats (these would need to come from the client, for now show placeholders)
            const memoryCommittedEl = document.getElementById('memoryCommitted');
            if (memoryCommittedEl) {
                memoryCommittedEl.textContent = '-';
            }
        }

        function updateCPUChart(cpuData) {
            const ctx = document.getElementById('cpuUtilizationChart');
            if (!ctx) return;

            const labels = cpuData.map((point, index) => {
                const secondsAgo = Math.floor((Date.now() - point.time) / 1000);
                return `${secondsAgo}s`;
            });
            const values = cpuData.map(point => point.value);

            if (cpuChart) {
                cpuChart.data.labels = labels;
                cpuChart.data.datasets[0].data = values;
                cpuChart.update('none');
            } else {
                cpuChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'CPU Utilization',
                            data: values,
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            }
                        }
                    }
                });
            }
        }

        function updateMemoryChart(memoryData, systemInfo) {
            const ctx = document.getElementById('memoryUtilizationChart');
            if (!ctx) return;

            const labels = memoryData.map((point, index) => {
                const secondsAgo = Math.floor((Date.now() - point.time) / 1000);
                return `${secondsAgo}s`;
            });
            const values = memoryData.map(point => (point.value / (1024 * 1024 * 1024)).toFixed(2));
            const maxMemory = systemInfo && systemInfo.total_memory_gb ? systemInfo.total_memory_gb : Math.max(...values) * 1.2;

            if (memoryChart) {
                memoryChart.data.labels = labels;
                memoryChart.data.datasets[0].data = values;
                memoryChart.options.scales.y.max = maxMemory;
                memoryChart.update('none');
            } else {
                memoryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Memory Usage',
                            data: values,
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: maxMemory,
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#64748b',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            }
                        }
                    }
                });
            }
        }

        function startTaskManagerRefresh(pcName) {
            stopTaskManagerRefresh();
            if (!pcName) return;
            
            // Load immediately
            loadTaskManagerData(pcName);
            
            // Then refresh every 3 seconds
            taskManagerRefreshInterval = setInterval(() => {
                loadTaskManagerData(pcName);
            }, TASK_MANAGER_REFRESH_INTERVAL);
        }

        function stopTaskManagerRefresh() {
            if (taskManagerRefreshInterval) {
                clearInterval(taskManagerRefreshInterval);
                taskManagerRefreshInterval = null;
            }
        }

        function showTaskManager(pcName) {
            if (!pcName) {
                alert('Please enter a PC name first');
                return;
            }
            
            // Show task manager section in status card
            const taskManagerSection = document.getElementById('taskManagerSection');
            if (taskManagerSection) {
                taskManagerSection.style.display = 'block';
                
                // Scroll to task manager section
                taskManagerSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Start refreshing
                startTaskManagerRefresh(pcName);
            }
        }

        function hideTaskManager() {
            const taskManagerSection = document.getElementById('taskManagerSection');
            if (taskManagerSection) {
                taskManagerSection.style.display = 'none';
                stopTaskManagerRefresh();
            }
            const btn = document.getElementById('taskManagerBtn');
            const btnText = document.getElementById('taskManagerBtnText');
            if (btn && btnText) {
                btnText.textContent = 'Show Processes';
            }
        }

        function toggleTaskManager() {
            const pcName = document.getElementById('pcName').value.trim();
            if (!pcName) {
                alert('Please enter a PC name first');
                return;
            }
            
            const taskManagerSection = document.getElementById('taskManagerSection');
            const btnText = document.getElementById('taskManagerBtnText');
            
            if (taskManagerSection && taskManagerSection.style.display === 'none') {
                showTaskManager(pcName);
                if (btnText) btnText.textContent = 'Hide Processes';
            } else {
                hideTaskManager();
            }
        }
        

    async function showAnalyticsReports() {
    // Global-in-function state
    let allPcUsage = {}; // All-PC aggregated usage (hours)
    let appUsage = {};   // Per-PC aggregated usage (hours)

    const pcName = document.getElementById('pcName').value.trim();
    const rangeConfig = getAnalyticsRangeConfig();
    const hasPcFilter = !!pcName;
    let appData = [];
    let sessionData = [];

    // Stop auto-refresh while viewing Analytics
    try { stopAutoRefresh(); } catch (e) { console.warn('stopAutoRefresh() failed or not defined yet', e); }
    const refreshIndicator = document.getElementById('refreshIndicator');
    if (refreshIndicator) refreshIndicator.style.display = 'none';

    const analyticsPlaceholder = document.getElementById('analyticsPlaceholder');
    const analyticsSection = document.getElementById('analyticsSection');
    if (analyticsPlaceholder) {
        analyticsPlaceholder.style.display = 'block';
        analyticsPlaceholder.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading analytics (${rangeConfig.label})...`;
    }
    if (analyticsSection) {
        analyticsSection.style.display = 'none';
    }

    // Wait for DOM layout to complete before fetching data
    await new Promise(resolve => setTimeout(resolve, 250));

    // Date range
    const { startIso, endIso } = rangeConfig;

    try {
        if (hasPcFilter) {
            const [
                { data: pcAppData, error: appErr },
                { data: pcSessionData, error: timeErr }
            ] = await Promise.all([
                supabase
                    .from('app_usage_logs')
                    .select('app_name, start_time, end_time, duration_seconds, memory_usage_bytes, cpu_percent, gpu_percent')
                    .eq('pc_name', pcName)
                    .gte('start_time', startIso)
                    .lte('end_time', endIso),
                supabase
                    .from('time_logs')
                    .select('start_time, end_time, duration_seconds')
                    .eq('pc_name', pcName)
                    .gte('start_time', startIso)
                    .lte('end_time', endIso)
            ]);

            if (appErr || timeErr) {
                console.error('Supabase errors:', appErr, timeErr);
                alert('Failed to load data from Supabase.');
                return;
            }

            appData = pcAppData || [];
            sessionData = pcSessionData || [];
        }

        // Fetch ALL-PC app usage (NO pc_name filter)
        const { data: allPcData, error: allPcErr } = await supabase
  .from('app_usage_logs')
  .select('pc_name, app_name, cpu_percent, memory_usage_bytes, duration_seconds, start_time')
  .gte('start_time', startIso)
  .lte('end_time', endIso)
  .not('cpu_percent', 'is', null)
  .not('memory_usage_bytes', 'is', null);


        // Aggregate All-PC usage (hours)
        if (allPcErr) {
            console.error('Error fetching all-PC app usage:', allPcErr);
        } else if (allPcData && allPcData.length > 0) {
            allPcUsage = {}; // reset
            allPcData.forEach(row => {
                const app = row.app_name || 'Unknown';
                const duration = (row.duration_seconds || 0) / 3600;
                allPcUsage[app] = (allPcUsage[app] || 0) + duration;
            });
        }

        // If no per-PC data and no sessions, show message
        const analyticsEntries = hasPcFilter ? (appData || []) : (allPcData || []);

        if (hasPcFilter && analyticsEntries.length === 0 && (!sessionData || !sessionData.length)) {
            alert(`No analytics data found for this PC and range (${rangeConfig.label}).`);
            return;
        }

        if (!hasPcFilter && analyticsEntries.length === 0) {
            alert(`No analytics data found for range (${rangeConfig.label}).`);
            return;
        }

        const rangeStartMs = new Date(startIso).getTime();
        const rangeEndMs = new Date(endIso).getTime();
        const idleSource = (sessionData && sessionData.length > 0) ? sessionData : analyticsEntries;
        const { activeSeconds: totalActiveSeconds } = computeActiveIdleFromEntries(idleSource, rangeStartMs, rangeEndMs);
        const totalActive = totalActiveSeconds / 3600;
        const MS_IN_DAY = 24 * 60 * 60 * 1000;
        const DAILY_EXPECTED_HOURS = 8;
        const expectedDays = Math.max(1, Math.ceil((rangeEndMs - rangeStartMs) / MS_IN_DAY));
        const expectedHours = expectedDays * DAILY_EXPECTED_HOURS;
        const idleTime = Math.max(0, expectedHours - totalActive);

        const cpuTrend = [];
        const memTrend = [];
        const timeLabels = [];
        let totalCpu = 0, totalMem = 0, count = 0;
        let peakCpu = 0, peakMem = 0;

        appUsage = {};
        if (analyticsEntries && analyticsEntries.length > 0) {
            analyticsEntries.forEach(a => {
                const app = a.app_name || 'Unknown';
                const duration = (a.duration_seconds || 0) / 3600;
                appUsage[app] = (appUsage[app] || 0) + duration;

                const cpu = Number(a.cpu_percent) || 0;
                const mem = (Number(a.memory_usage_bytes) || 0) / (1024 ** 3);
                totalCpu += cpu;
                totalMem += mem;
                count++;

                if (cpu > peakCpu) peakCpu = cpu;
                if (mem > peakMem) peakMem = mem;

                const timeStr = a.start_time ? new Date(a.start_time).toLocaleTimeString('en-US', {
                    hour: '2-digit', minute: '2-digit', hour12: false
                }) : '';
                cpuTrend.push(cpu);
                memTrend.push(mem);
                timeLabels.push(timeStr);
            });
        }

        const avgCpu = count > 0 ? totalCpu / count : 0;
        const avgMem = count > 0 ? totalMem / count : 0;
        const totalSessions = analyticsEntries.length;
        const avgSessionDuration = totalSessions > 0 ? (totalActiveSeconds / totalSessions / 60) : 0; // minutes
        const resourceEfficiencyRatio = idleTime > 0 ? (totalActive / idleTime).toFixed(2) : (totalActive > 0 ? '' : '0');

        // Update summary cards
        document.getElementById('totalActiveTime').textContent = totalActive.toFixed(1) + 'h';
        document.getElementById('idleTime').textContent = idleTime.toFixed(1) + 'h';
        document.getElementById('avgCpuLoad').textContent = avgCpu.toFixed(1) + '%';
        document.getElementById('avgMemUsage').textContent = avgMem.toFixed(2) + ' GB';

        document.getElementById('peakCpuLoad').textContent = peakCpu.toFixed(1) + '%';
        document.getElementById('peakMemory').textContent = peakMem.toFixed(2) + ' GB';
        document.getElementById('totalSessions').textContent = totalSessions;
        document.getElementById('avgSessionDuration').textContent = avgSessionDuration.toFixed(1) + ' min';
        document.getElementById('avgCpuUsage').textContent = avgCpu.toFixed(1) + '%';
        document.getElementById('resourceEfficiency').textContent = resourceEfficiencyRatio + ':1';
    
            // Calculate Top Memory Hogs
            const memoryHogs = {};
            if (analyticsEntries && analyticsEntries.length > 0) {
                analyticsEntries.forEach(a => {
                    const app = a.app_name || 'Unknown';
                    const mem = (Number(a.memory_usage_bytes) || 0) / (1024 ** 3); // Convert to GB
                    
                    if (!memoryHogs[app]) {
                        memoryHogs[app] = {
                            name: app,
                            peakMemory: mem,
                            totalMemory: mem,
                            count: 1,
                            sessions: []
                        };
                    } else {
                        memoryHogs[app].totalMemory += mem;
                        memoryHogs[app].count += 1;
                        if (mem > memoryHogs[app].peakMemory) {
                            memoryHogs[app].peakMemory = mem;
                        }
                    }
                    memoryHogs[app].sessions.push({
                        startTime: a.start_time,
                        memory: mem
                    });
                });
            }

            // Sort by peak memory and get top 10
            const topMemoryApps = Object.values(memoryHogs)
                .sort((a, b) => b.peakMemory - a.peakMemory)
                .slice(0, 10);

            // Update Top Memory Hogs table
            const topMemoryTable = document.getElementById('topMemoryHogsTable');
            if (topMemoryTable) {
                if (topMemoryApps.length === 0) {
                    topMemoryTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="padding:30px; text-align:center; color:#64748b;">
                                <i class="fas fa-inbox"></i> No memory data available
                            </td>
                        </tr>
                    `;
                } else {
                    topMemoryTable.innerHTML = topMemoryApps.map((app, index) => {
                        const avgMemory = app.totalMemory / app.count;
                        const isHighMemory = app.peakMemory > 1.0; // Flag if > 1GB
                        const statusColor = isHighMemory ? '#ef4444' : '#22c55e';
                        const statusIcon = isHighMemory ? 'fa-alert-circle' : 'fa-check-circle';
                        const statusText = isHighMemory ? 'High' : 'Normal';
                        
                        return `
                            <tr style="border-bottom:1px solid #e5e7eb;">
                                <td style="padding:15px; color:#1f2937; font-weight:500;">
                                    <i class="fas fa-cube" style="color:#6366f1; margin-right:8px;"></i>
                                    ${escapeHtml(app.name)}
                                </td>
                                <td style="padding:15px; text-align:center; color:#1f2937; font-weight:600;">
                                    ${app.peakMemory.toFixed(2)} GB
                                </td>
                                <td style="padding:15px; text-align:center; color:#64748b;">
                                    ${avgMemory.toFixed(2)} GB
                                </td>
                                <td style="padding:15px; text-align:center; color:#64748b;">
                                    ${app.count}
                                </td>
                                <td style="padding:15px; text-align:center;">
                                    <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 12px; background:${statusColor}20; color:${statusColor}; border-radius:20px; font-size:0.85rem; font-weight:600;">
                                        <i class="fas ${statusIcon}" style="font-size:0.9rem;"></i>
                                        ${statusText}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

                        // Calculate Top CPU Consumers
            const cpuHogs = {};
            if (analyticsEntries && analyticsEntries.length > 0) {
                analyticsEntries.forEach(a => {
                    const app = a.app_name || 'Unknown';
                    const cpu = Number(a.cpu_percent) || 0;
                    
                    if (!cpuHogs[app]) {
                        cpuHogs[app] = {
                            name: app,
                            peakCpu: cpu,
                            totalCpu: cpu,
                            count: 1,
                            sessions: []
                        };
                    } else {
                        cpuHogs[app].totalCpu += cpu;
                        cpuHogs[app].count += 1;
                        if (cpu > cpuHogs[app].peakCpu) {
                            cpuHogs[app].peakCpu = cpu;
                        }
                    }
                    cpuHogs[app].sessions.push({
                        startTime: a.start_time,
                        cpu: cpu
                    });
                });
            }

                        
            // Sort by peak CPU and get top 10
            const topCpuApps = Object.values(cpuHogs)
                .sort((a, b) => b.peakCpu - a.peakCpu)
                .slice(0, 10);

            // Update Top CPU Consumers table
            const topCpuTable = document.getElementById('topCpuConsumersTable');
            if (topCpuTable) {
                if (topCpuApps.length === 0) {
                    topCpuTable.innerHTML = `
                        <tr>
                            <td colspan="5" style="padding:30px; text-align:center; color:#64748b;">
                                <i class="fas fa-inbox"></i> No CPU data available
                            </td>
                        </tr>
                    `;
                } else {
                    topCpuTable.innerHTML = topCpuApps.map((app, index) => {
                        const avgCpu = app.totalCpu / app.count;
                        const isHighCpu = app.peakCpu > 50; // Flag if peak > 50%
                        const statusColor = isHighCpu ? '#ef4444' : '#22c55e';
                        const statusIcon = isHighCpu ? 'fa-warning' : 'fa-check-circle';
                        const statusText = isHighCpu ? 'High' : 'Normal';
                        
                        return `
                            <tr style="border-bottom:1px solid #e5e7eb;">
                                <td style="padding:15px; color:#1f2937; font-weight:500;">
                                    <i class="fas fa-microchip" style="color:#f59e0b; margin-right:8px;"></i>
                                    ${escapeHtml(app.name)}
                                </td>
                                <td style="padding:15px; text-align:center; color:#1f2937; font-weight:600;">
                                    ${app.peakCpu.toFixed(1)} %
                                </td>
                                <td style="padding:15px; text-align:center; color:#64748b;">
                                    ${avgCpu.toFixed(1)} %
                                </td>
                                <td style="padding:15px; text-align:center; color:#64748b;">
                                    ${app.count}
                                </td>
                                <td style="padding:15px; text-align:center;">
                                    <span style="display:inline-flex; align-items:center; gap:6px; padding:4px 12px; background:${statusColor}20; color:${statusColor}; border-radius:20px; font-size:0.85rem; font-weight:600;">
                                        <i class="fas ${statusIcon}" style="font-size:0.9rem;"></i>
                                        ${statusText}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            }

            // Prepare top apps
            const sortedApps = Object.entries(appUsage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            const labels = sortedApps.map(a => a[0]);
            const values = sortedApps.map(a => Number(a[1].toFixed(2)));

            // Prepare top apps (all PCs)
            const sortedAllPcApps = Object.entries(allPcUsage)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
            const labelsAll = sortedAllPcApps.map(a => a[0]);
            const valuesAll = sortedAllPcApps.map(a => Number(a[1].toFixed(2)));

            // Destroy old chart if exists
if (window.allPcPieChart) {
    try { window.allPcPieChart.destroy(); } catch(e) {}
    window.allPcPieChart = null;
}

// Get canvas and render chart
const pieCanvas = document.getElementById('allPcUsagePieChart');
if (pieCanvas && labelsAll.length > 0) {
    window.allPcPieChart = new Chart(pieCanvas.getContext('2d'), {
        type: 'doughnut', // or 'pie'
        data: {
            labels: labelsAll,
            datasets: [{
                label: 'Application Usage Distribution (All PCs)',
                data: valuesAll,
                backgroundColor: [
                    '#6366f1', '#22c55e', '#ef4444', '#f59e0b',
                    '#3b82f6', '#8b5cf6', '#14b8a6', '#f97316',
                    '#64748b', '#84cc16'
                ],
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: { boxWidth: 20 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw} hours`;
                        }
                    }
                }
            }
        }
    });
}

// Destroy old chart if exists
if (window.performanceMetricsChart) {
    try { window.performanceMetricsChart.destroy(); } catch (e) {}
    window.performanceMetricsChart = null;
}

const metricsCanvas = document.getElementById('performanceMetricsChart');
if (metricsCanvas && allPcData && allPcData.length > 0) {
    const pcStats = {};

    // Aggregate metrics per PC
    allPcData.forEach(row => {
        const pc = row.pc_name;
        if (!pc) return;

        const cpu = Number(row.cpu_percent) || 0;
        const mem = (Number(row.memory_usage_bytes) || 0) / (1024 ** 3);
        const duration = Number(row.duration_seconds) || 0;

        if (!pcStats[pc]) {
            pcStats[pc] = { totalCpu: 0, totalMem: 0, totalDuration: 0, sessions: 0 };
        }

        pcStats[pc].totalCpu += cpu;
        pcStats[pc].totalMem += mem;
        pcStats[pc].totalDuration += duration;
        pcStats[pc].sessions++;
    });

    const labels = Object.keys(pcStats);
    const cpuData = [];
    const memData = [];
    const sessionData = [];
    const durationData = [];

    labels.forEach(pc => {
        const stats = pcStats[pc];
        const avgCpu = stats.totalCpu / stats.sessions;
        const avgMem = stats.totalMem / stats.sessions;
        const avgDuration = (stats.totalDuration / stats.sessions) / 60; // seconds  minutes
        const totalSessions = stats.sessions;

        cpuData.push(avgCpu);
        memData.push(avgMem);
        sessionData.push(totalSessions);
        durationData.push(avgDuration);
    });

    window.performanceMetricsChart = new Chart(metricsCanvas.getContext('2d'), {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Avg CPU (%)',
                    data: cpuData,
                    backgroundColor: '#3b82f6'
                },
                {
                    label: 'Avg Memory (GB)',
                    data: memData,
                    backgroundColor: '#10b981'
                },
                {
                    label: 'Total Sessions',
                    data: sessionData,
                    backgroundColor: '#f59e0b'
                },
                {
                    label: 'Avg Duration (min)',
                    data: durationData,
                    backgroundColor: '#ef4444'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { size: 12 },
                        color: '#374151'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.raw.toFixed(2)}`
                    }
                }
            },
            scales: {
                x: {
                    stacked: false,
                    title: { display: true, text: 'PC Name' }
                },
                y: {
                    stacked: false,
                    beginAtZero: true,
                    title: { display: true, text: 'Metric Value' }
                }
            }
        }
    });
}

// Destroy old scatter chart if exists
if (window.resourceEfficiencyChart) {
    try { window.resourceEfficiencyChart.destroy(); } catch(e) {}
    window.resourceEfficiencyChart = null;
}

const scatterCanvas = document.getElementById('resourceEfficiencyChart');
if (scatterCanvas && allPcData && allPcData.length > 0) {
    const pcStats = {};

    // Aggregate CPU, Memory and Duration per PC
    allPcData.forEach(row => {
        const pc = row.pc_name;
        const cpuRaw = row.cpu_percent;
        const memRaw = row.memory_usage_bytes;
        const dur = Number(row.duration_seconds) || 0;

        if (!pc || cpuRaw == null || memRaw == null) {
            // skip invalid rows
            return;
        }

        const cpu = Number(cpuRaw);
        const mem = Number(memRaw) / (1024 ** 3); // bytes  GB

        if (!pcStats[pc]) {
            pcStats[pc] = { totalCpu: 0, totalMem: 0, totalDuration: 0, count: 0 };
        }
        pcStats[pc].totalCpu += cpu;
        pcStats[pc].totalMem += mem;
        pcStats[pc].totalDuration += dur;
        pcStats[pc].count++;
    });

    // Build datasets: each PC becomes a single bubble (x=avgCpu, y=avgMem, r=avgDuration)
    const datasets = Object.entries(pcStats).map(([pc, stats], idx) => {
        const avgCpu = stats.totalCpu / stats.count;
        const avgMem = stats.totalMem / stats.count;
        const avgDurationMin = (stats.totalDuration / stats.count) / 60; // minutes

        // Map avg duration to radius (px) with reasonable bounds
        const r = Math.max(6, Math.min(30, Math.round(avgDurationMin * 0.6 + 4)));

        const colorPalette = ['#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6','#6366f1','#14b8a6','#f97316','#64748b','#84cc16'];
        const color = colorPalette[idx % colorPalette.length];

        return {
            label: pc,
            data: [{ x: +avgCpu.toFixed(2), y: +avgMem.toFixed(3), r }],
            backgroundColor: color + '80', // semi-transparent
            borderColor: color,
            borderWidth: 1,
            hoverBackgroundColor: color + 'c0'
        };
    });

    if (datasets.length > 0) {
        // Destroy previous if present (the page already handles some destruction, but safe to repeat)
        if (window.resourceEfficiencyChart) {
            try { window.resourceEfficiencyChart.destroy(); } catch(e) {}
            window.resourceEfficiencyChart = null;
        }

        window.resourceEfficiencyChart = new Chart(scatterCanvas.getContext('2d'), {
            type: 'bubble',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const x = context.raw.x !== undefined ? context.raw.x : (context.parsed && context.parsed.x);
                                const y = context.raw.y !== undefined ? context.raw.y : (context.parsed && context.parsed.y);
                                const rVal = context.raw.r || (context.parsed && context.parsed.r) || '';
                                return `${label}: CPU ${Number(x).toFixed(1)}%, Mem ${Number(y).toFixed(2)} GB, bubble ~ ${rVal}px (avg session)`;
                            }
                        }
                    },
                    legend: { position: 'right' }
                },
                scales: {
                    x: {
                        title: { display: true, text: 'Average CPU Usage (%)' },
                        beginAtZero: true
                    },
                    y: {
                        title: { display: true, text: 'Average Memory Usage (GB)' },
                        beginAtZero: true
                    }
                }
            }
        });
    } else {
        console.warn('No valid PC data found for bubble chart.');
    }
}

            // Destroy old charts
            if (window.allPcChart) {
                try { window.allPcChart.destroy(); } catch(e) {}
                window.allPcChart = null;
            }
            if (window.appChart) {
                try { window.appChart.destroy(); } catch(e) {}
                window.appChart = null;
            }
            if (window.cpuChart) {
                try { window.cpuChart.destroy(); } catch(e) {}
                window.cpuChart = null;
            }
            if (window.memChart) {
                try { window.memChart.destroy(); } catch(e) {}
                window.memChart = null;
            }

            // CRITICAL: Wait again for canvas measurement before creating charts
            await new Promise(resolve => setTimeout(resolve, 150));

            // Get canvas elements
            const analyticsAppCanvas = document.getElementById('analyticsAppChart');
            const analyticsCpuCanvas = document.getElementById('analyticsCpuChart');
            const analyticsMemCanvas = document.getElementById('analyticsMemChart');
            const analyticsAllPcCanvas = document.getElementById('analyticsAllPcChart');

            console.log('Canvas elements:', {
                app: !!analyticsAppCanvas,
                cpu: !!analyticsCpuCanvas,
                mem: !!analyticsMemCanvas
            });

            // Create App Chart
            if (analyticsAppCanvas && labels.length > 0) {
                window.appChart = new Chart(analyticsAppCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Usage (hours)',
                            data: values,
                            backgroundColor: '#6366f1',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false } },
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Create All-PC Chart (stacked by PC per application)
            if (analyticsAllPcCanvas && labelsAll.length > 0 && allPcData && allPcData.length > 0) {
                // Build mapping: app -> { pcName: hours, ... }
                const appPcMap = {};
                const pcTotals = {};

                allPcData.forEach(row => {
                    const app = row.app_name || 'Unknown';
                    const pc = row.pc_name || 'Unknown PC';
                    const hours = (Number(row.duration_seconds) || 0) / 3600;

                    if (!appPcMap[app]) appPcMap[app] = {};
                    appPcMap[app][pc] = (appPcMap[app][pc] || 0) + hours;

                    pcTotals[pc] = (pcTotals[pc] || 0) + hours;
                });

                // Choose top PCs to display individually, aggregate the rest into "Other PCs"
                const pcList = Object.keys(pcTotals).sort((a, b) => pcTotals[b] - pcTotals[a]);
                const MAX_PCS = 6; // keep chart readable
                const topPcs = pcList.slice(0, MAX_PCS);
                const otherPcs = pcList.slice(MAX_PCS);

                // Build dataset for each PC
                const colorPalette = ['#6366f1', '#22c55e', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#14b8a6', '#f97316', '#64748b', '#84cc16'];
                const datasets = [];

                topPcs.forEach((pc, idx) => {
                    const data = labelsAll.map(app => {
                        return +(appPcMap[app] && appPcMap[app][pc] ? appPcMap[app][pc].toFixed(3) : 0);
                    });

                    datasets.push({
                        label: pc,
                        data,
                        backgroundColor: colorPalette[idx % colorPalette.length],
                        borderColor: colorPalette[idx % colorPalette.length],
                        borderWidth: 1
                    });
                });

                // Aggregate 'Other PCs' if any
                if (otherPcs.length > 0) {
                    const otherData = labelsAll.map(app => {
                        let sum = 0;
                        otherPcs.forEach(pc => {
                            if (appPcMap[app] && appPcMap[app][pc]) sum += appPcMap[app][pc];
                        });
                        return +sum.toFixed(3);
                    });

                    datasets.push({
                        label: 'Other PCs',
                        data: otherData,
                        backgroundColor: '#94a3b8',
                        borderColor: '#94a3b8',
                        borderWidth: 1
                    });
                }

                // Destroy existing chart if present
                if (window.allPcChart) {
                    try { window.allPcChart.destroy(); } catch (e) {}
                    window.allPcChart = null;
                }

                // Create stacked bar chart: apps on X axis, stacks are PCs
                window.allPcChart = new Chart(analyticsAllPcCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labelsAll,
                        datasets: datasets
                    },
                    options: {
                        plugins: {
                            legend: { position: 'right' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${Number(context.raw).toFixed(2)} h`;
                                    }
                                }
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            x: { stacked: true, title: { display: true, text: 'Applications' } },
                            y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Active Time (hours)' } }
                        }
                    }
                });
            }

            // Create CPU Chart
            if (analyticsCpuCanvas && cpuTrend.length > 0) {
                window.cpuChart = new Chart(analyticsCpuCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'CPU (%)',
                            data: cpuTrend,
                            backgroundColor: '#f59e0b',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100 },
                            x: { ticks: { autoSkip: true } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Create Memory Chart
            if (analyticsMemCanvas && memTrend.length > 0) {
                window.memChart = new Chart(analyticsMemCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: timeLabels,
                        datasets: [{
                            label: 'Memory (GB)',
                            data: memTrend,
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true },
                            x: { ticks: { autoSkip: true } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // Update summary text
            const topApp = sortedApps[0] ? `${sortedApps[0][0]} (${sortedApps[0][1].toFixed(1)}h)` : 'None';
            const scopeLabel = hasPcFilter ? escapeHtml(pcName) : 'All PCs (aggregated)';
            document.getElementById('analyticsSummary').innerHTML =
                `<strong>Range:</strong> ${escapeHtml(rangeConfig.label)}<br>
                 <strong>Scope:</strong> ${scopeLabel}<br>
                 <strong>Most used app:</strong> ${escapeHtml(topApp)}<br>
                 <strong>Average CPU:</strong> ${avgCpu.toFixed(1)}%<br>
                 <strong>Average Memory:</strong> ${avgMem.toFixed(2)} GB<br>
                 <strong>Idle Time:</strong> ${idleTime.toFixed(1)} hours<br>
                 <strong>Total Active Time:</strong> ${totalActive.toFixed(1)}`;    

                 // Convert hours to minutes for chart
const totalActiveMinutes = totalActive * 60;
const totalIdleMinutes = idleTime * 60;

// Render Active vs Idle chart
createActiveIdleChart(totalActiveMinutes, totalIdleMinutes);
           

            console.log('Analytics rendered successfully');

            if (analyticsPlaceholder) {
                analyticsPlaceholder.style.display = 'none';
            }
            if (analyticsSection) {
                analyticsSection.style.display = 'block';
            }

        } catch (error) {
            console.error('Error in showAnalyticsReports:', error);
            if (analyticsPlaceholder) {
                analyticsPlaceholder.innerHTML = '<i class="fas fa-exclamation-circle"></i> Unable to load analytics. Please try again.';
            }
            alert('Error loading analytics: ' + error.message);
        }
    }

    // CSV Export Function with Enhanced Data & Better Formatting
    function downloadAnalyticsCSV() {
        const rawPcName = document.getElementById('pcName').value.trim();
        const pcName = rawPcName || 'All PCs';
        const rangeConfig = getAnalyticsRangeConfig();
        const reportRange = rangeConfig.label;

        // Get data from the summary cards
        const totalActiveTime = document.getElementById('totalActiveTime').textContent;
        const idleTime = document.getElementById('idleTime').textContent;
        const avgCpuLoad = document.getElementById('avgCpuLoad').textContent;
        const avgMemUsage = document.getElementById('avgMemUsage').textContent;
        const peakCpuLoad = document.getElementById('peakCpuLoad').textContent;
        const peakMemory = document.getElementById('peakMemory').textContent;
        const totalSessions = document.getElementById('totalSessions').textContent;
        const avgSessionDuration = document.getElementById('avgSessionDuration').textContent;
        const resourceEfficiency = document.getElementById('resourceEfficiency').textContent;

        // Get PC system info if available
        const systemInfoGrid = document.getElementById('systemInfoGrid');
        let cpuModel = 'N/A', totalRam = 'N/A', osVersion = 'N/A', lastOnline = 'N/A';
        
        if (systemInfoGrid) {
            const items = systemInfoGrid.querySelectorAll('.system-info-item');
            items.forEach(item => {
                const label = item.querySelector('.label')?.textContent.toLowerCase() || '';
                const value = item.querySelector('.value')?.textContent || 'N/A';
                
                if (label.includes('cpu') || label.includes('processor')) cpuModel = value;
                if (label.includes('ram') || label.includes('memory')) totalRam = value;
                if (label.includes('os') || label.includes('windows')) osVersion = value;
                if (label.includes('last') || label.includes('online')) lastOnline = value;
            });
        }

        // Helper function to escape CSV values
        const escapeCSVValue = (val) => {
            if (val === null || val === undefined) return '';
            const str = String(val).trim();
            // Always quote strings to avoid truncation and special character issues
            return `"${str.replace(/"/g, '""')}"`;
        };

        // Build CSV lines array for better control
        let csvLines = [];
        
        // Header Section - Single column format for better alignment
        csvLines.push('"Analytics Report - ICS Lab Monitor"');
        csvLines.push(`"Generated: ${new Date().toLocaleString()}"`);
        csvLines.push(`"PC Name: ${pcName}"`);
        csvLines.push(`"Report Range: ${reportRange}"`);
        csvLines.push(''); // Blank line

        // System Information Section
        csvLines.push('"SYSTEM INFORMATION"');
        csvLines.push('"Property","Value"');
        csvLines.push(`"CPU Model",${escapeCSVValue(cpuModel)}`);
        csvLines.push(`"Total Memory",${escapeCSVValue(totalRam)}`);
        csvLines.push(`"Operating System",${escapeCSVValue(osVersion)}`);
        csvLines.push(`"Last Seen Online",${escapeCSVValue(lastOnline)}`);
        csvLines.push(''); // Blank line

        // Summary Section
        csvLines.push('"SUMMARY METRICS"');
        csvLines.push('"Metric","Value","Unit"');
        csvLines.push(`"Total Active Time","${totalActiveTime}","Hours"`);
        csvLines.push(`"Idle Time","${idleTime}","Hours"`);
        csvLines.push(`"Average CPU Load","${avgCpuLoad}","Percentage"`);
        csvLines.push(`"Average Memory Usage","${avgMemUsage}","GB"`);
        csvLines.push(`"Peak CPU Load","${peakCpuLoad}","Percentage"`);
        csvLines.push(`"Peak Memory","${peakMemory}","GB"`);
        csvLines.push(`"Total Sessions","${totalSessions}","Count"`);
        csvLines.push(`"Average Session Duration","${avgSessionDuration}","Minutes"`);
        csvLines.push(`"Resource Efficiency Ratio","${resourceEfficiency}","Ratio"`);
        csvLines.push(''); // Blank line

        // App Usage Section
        const appTableBody = document.getElementById('appTableBody');
        if (appTableBody && appTableBody.children.length > 0) {
            csvLines.push('"APP USAGE DETAILS"');
            csvLines.push('"Application Name","Active Time (Minutes)","CPU % (Average)","Memory (GB Average)","Sessions Count"');
            
            Array.from(appTableBody.children).forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const appName = cells[0].textContent.trim();
                    const activeTime = cells[1].textContent.trim();
                    const cpu = cells[2].textContent.trim();
                    const memory = cells[3].textContent.trim();
                    const sessions = cells[4].textContent.trim();
                    
                    csvLines.push(`${escapeCSVValue(appName)},"${activeTime}","${cpu}","${memory}","${sessions}"`);
                }
            });
        }

        // Join all lines with newlines
        const csvContent = csvLines.join('\n');

        // Create blob for better encoding handling
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        const rangeSlug = reportRange ? reportRange.replace(/[^\w]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '') : 'range';
        link.setAttribute('download', `analytics_${pcName}_${rangeSlug}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        console.log('CSV exported successfully with proper formatting and full text visibility');
    }</script>
</body>
</html>