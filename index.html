<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICS Lab Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" href="icon.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* Light mode colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --container-bg: #ffffff;
            --text-primary: #333;
            --text-secondary: #64748b;
            --text-heading: #1f2937;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --navbar-bg: #ffffff;
            --navbar-shadow: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: #e5e7eb;
            --stat-card-bg: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            --controls-bg: #f8fafc;
            --table-header-bg: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --pc-card-bg: #ffffff;
            --empty-state-bg: #f8fafc;
        }

        body.dark-mode {
            /* Dark mode colors */
            --bg-gradient-start: #1f2937;
            --bg-gradient-end: #111827;
            --container-bg: #1f2937;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-heading: #f9fafb;
            --card-bg: #374151;
            --card-border: #4b5563;
            --navbar-bg: #1f2937;
            --navbar-shadow: rgba(0, 0, 0, 0.3);
            --input-bg: #374151;
            --input-border: #4b5563;
            --stat-card-bg: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            --controls-bg: #1f2937;
            --table-header-bg: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            --pc-card-bg: #374151;
            --empty-state-bg: #1f2937;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 0;
            padding-top: 60px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--container-bg);
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .auto-refresh-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            margin-left: 15px;
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            opacity: 0.8;
        }

        .auto-refresh-indicator i {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }


        .controls {
            background: #f8fafc;
            padding: 30px 40px;
            border-bottom: 1px solid #e2e8f0;
        }

        .control-group {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid var(--input-border);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            height: 45px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .pc-status-container {
            padding: 30px 40px;
            background: var(--controls-bg);
            border-bottom: 1px solid var(--card-border);
        }

        .pc-status-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .pc-status-card:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .pc-status-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--card-border);
        }

        .status-indicator-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #22c55e;
            position: relative;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
        }

        .status-indicator.offline {
            background: #ef4444;
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline::after {
            animation: none;
        }

        .status-indicator.idle {
            background: #f59e0b;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2);
        }

        .status-indicator.idle::after {
            background: rgba(245, 158, 11, 0.3);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }

            70% {
                transform: scale(2.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        .pc-info h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--text-heading);
            font-weight: 700;
        }

        .pc-info .status-text {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pc-info .status-text i {
            font-size: 0.9rem;
        }

        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .system-info-item {
            background: var(--controls-bg);
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #4f46e5;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .system-info-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .system-info-value {
            font-size: 1.1rem;
            color: var(--text-heading);
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px 40px;
            background: var(--controls-bg);
        }

        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--card-border);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #4f46e5;
        }

        .stat-card .number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-heading);
            margin-bottom: 8px;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .tab-content {
            padding: 30px 40px;
            display: none;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 0 auto;
        }

        .chart-container canvas {
            max-height: 400px !important;
            max-width: 100% !important;
            width: 100% !important;
            height: 400px !important;
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-heading);
            margin-bottom: 15px;
            text-align: center;
        }

        .data-table {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--table-header-bg);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--card-border);
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--empty-state-bg);
        }


        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-heading);
        }

        /* Task Manager Styles */
        .task-manager-header-section {
            margin-bottom: 20px;
        }

        .task-manager-graph-container {
            background: var(--controls-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--card-border);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .graph-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .graph-time-label {
            color: var(--text-secondary);
        }

        .graph-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .task-manager-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-manager-stats-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-manager-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .task-manager-stat-item:last-child {
            border-bottom: none;
        }

        .task-manager-stat-item .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .task-manager-stat-item .stat-value {
            font-size: 0.95rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .task-manager-stat-item .stat-value-large {
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .task-manager-memory-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--text-secondary);
        }

        /* Home/Dashboard Page Styles */
        .home-container {
            padding: 30px 40px;
            display: none;
        }

        .home-container.active {
            display: block;
        }

        .pcs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pc-card {
            background: var(--pc-card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid var(--card-border);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .pc-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            border-color: #4f46e5;
        }

        .pc-card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .pc-card-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }

        .pc-card-status.offline {
            background: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .pc-card-status.idle {
            background: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }

        .pc-card-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-heading);
            flex: 1;
        }

        .pc-card-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .pc-card-info-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid var(--card-border);
        }

        .pc-card-info-item:last-child {
            border-bottom: none;
        }


        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-heading);
            margin-bottom: 10px;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
            flex-wrap: wrap;
        }

        .pagination-btn {
            padding: 10px 20px;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            padding: 10px 20px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .pagination-page-numbers {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .page-number {
            padding: 8px 12px;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
        }

        .page-number:hover {
            background: var(--empty-state-bg);
            border-color: #4f46e5;
        }

        .page-number.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        .error {
            background: #ef4444;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }

            .header .subtitle {
                font-size: 0.85rem;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .auto-refresh-indicator {
                margin-left: 0;
                margin-top: 10px;
                font-size: 0.75rem;
            }

            .controls {
                padding: 20px 15px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .form-group label {
                font-size: 0.85rem;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px 15px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-card i {
                font-size: 2rem;
            }

            .stat-card .number {
                font-size: 1.8rem;
            }

            .tab-content {
                padding: 20px 15px;
            }

            .chart-container {
                padding: 20px 15px;
            }

            .chart-wrapper {
                height: 300px;
            }

            .data-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
                font-size: 0.75rem;
            }

            th,
            td {
                padding: 8px 6px;
                font-size: 0.75rem;
            }

            .pcs-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .pc-card {
                padding: 15px;
            }

            .pc-card-name {
                font-size: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .page-subtitle {
                font-size: 0.9rem;
            }

            .pagination {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .pagination-btn {
                width: 100%;
                max-width: 200px;
                padding: 12px 20px;
            }

            .pagination-info {
                padding: 10px;
                font-size: 0.9rem;
                text-align: center;
            }

            .pagination-page-numbers {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
            }

            .page-number {
                padding: 6px 10px;
                font-size: 0.85rem;
                min-width: 35px;
            }

            .home-container {
                padding: 15px;
            }

            .pc-status-container {
                padding: 15px;
            }

            .pc-status-card {
                padding: 20px;
            }

            .pc-status-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .system-info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }


            .pc-card-info-item {
                font-size: 0.8rem;
            }

            /* Shareable link section mobile */
            #shareableLink {
                font-size: 0.8rem;
                padding: 10px;
            }

            /* PC status card shareable link */
            .pc-status-card>div:last-child {
                flex-direction: column;
                gap: 10px;
            }

            .pc-status-card>div:last-child>div {
                flex-direction: column;
                width: 100%;
            }

            .task-manager-container {
                padding: 15px;
            }

            .task-manager-stats-grid {
                grid-template-columns: 1fr;
            }

            .task-manager-memory-stats {
                grid-template-columns: 1fr;
            }

            .pc-status-card>div:last-child input {
                width: 100%;
                min-width: auto;
            }

            .pc-status-card>div:last-child button {
                width: 100%;
            }
        }

        /* Navbar Styles */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--navbar-bg);
            box-shadow: 0 2px 4px var(--navbar-shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
            transition: all 0.3s ease;
        }

        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4f46e5;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .navbar-logo i {
            font-size: 1.8rem;
        }

        .navbar-center {
            display: flex;
            gap: 8px;
            flex: 1;
            justify-content: center;
            max-width: 600px;
        }

        .navbar-item {
            padding: 8px 40px;
            border-radius: 8px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #65676b;
            font-size: 1.2rem;
            position: relative;
        }

        .navbar-item:hover {
            background: #f0f2f5;
        }

        .navbar-item.active {
            color: #4f46e5;
        }

        .navbar-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            height: 3px;
            background: #4f46e5;
            border-radius: 3px 3px 0 0;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 0 10px;
            }

            .navbar-logo span {
                display: none;
            }

            .navbar-center {
                gap: 4px;
            }

            .navbar-item {
                padding: 8px 20px;
            }
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: #4f46e5;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        /* Navbar input styles */
        .navbar-input {
            padding: 8px 12px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.9rem;
            margin-right: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .navbar-input:focus {
            outline: none;
            border-color: #4f46e5;
        }

        /* Right Sidebar Navigation (Dropdown) */
        .right-sidebar {
            position: absolute;
            left: 50%;
            top: 100%;
            transform: translateX(-50%);
            margin-top: 15px;
            width: 180px;
            background: var(--navbar-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1002;
            display: none;
            transition: all 0.3s ease;
            border: 1px solid var(--card-border);
        }

        /* Add arrow for dropdown */
        .right-sidebar::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%) rotate(45deg);
            width: 12px;
            height: 12px;
            background: var(--navbar-bg);
            border-left: 1px solid var(--card-border);
            border-top: 1px solid var(--card-border);
        }

        .right-sidebar.active {
            display: block;
        }

        .sidebar-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--card-border);
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
            text-decoration: none;
        }

        .sidebar-nav-item:hover {
            background: var(--empty-state-bg);
            color: #4f46e5;
            transform: translateX(3px);
        }

        .sidebar-nav-item.active {
            background: transparent;
            color: #4f46e5;
            font-weight: 600;
        }

        .sidebar-nav-item i {
            font-size: 0.8rem;
            width: 14px;
            text-align: center;
        }

        /* Add position relative to detail page for sidebar positioning */
        #detailPage {
            position: relative;
        }

        @media (max-width: 1200px) {
            .right-sidebar {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <a href="#" class="navbar-logo" onclick="showHome(); return false;">
                    <i class="fas fa-desktop"></i>
                    <span>ICS Lab Monitor</span>
                </a>
            </div>
            <div class="navbar-center">
                <button class="navbar-item active" id="nav-home" onclick="showPage('home')" title="Home">
                    <i class="fas fa-home"></i>
                </button>
                <div style="position: relative;">
                    <button class="navbar-item" id="nav-dashboard" onclick="return false;" title="Dashboard"
                        style="display: none;">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <div class="right-sidebar" id="rightSidebar">

                        <a href="#tab-btn-apps" class="sidebar-nav-item"
                            onclick="scrollToSection('tab-btn-apps'); return false;">
                            <i class="fas fa-window-maximize"></i>
                            <span>App Usage</span>
                        </a>
                    </div>
                </div>
                <button class="navbar-item" id="nav-analytics" onclick="showPage('analytics')" title="Analytics">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button class="navbar-item" id="nav-notifications" onclick="showPage('notifications')"
                    title="Notifications">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="navbar-item" id="nav-settings" onclick="showPage('settings')" title="Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            <div class="navbar-right">
                <input type="text" id="pcName" placeholder="PC Name" class="navbar-input" style="width: 150px;">
                <input type="date" id="selectedDate" class="navbar-input">
                <button onclick="loadData()"
                    style="padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
    </nav>

    <div class="container">


        <!-- Home/Dashboard Page -->
        <div class="home-container active" id="homePage">


            <div class="form-group">
                <h2 class="page-title">Available PCs</h2>
                <p class="page-subtitle">Click on a PC or search manually to view its details and activity</p>
                <!-- Task Manager Section -->
                <div id="taskManagerSection" style="display: none; margin-top: 30px;">
                    <h3 style="margin-bottom: 20px; color: #1f2937;">
                        <i class="fas fa-tasks"></i> Performance Monitor
                    </h3>
                </div>
            </div>
            <div class="pcs-grid" id="pcsGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i> Loading PCs...
                </div>
            </div>
        </div>

        <!-- Analytics Page -->
        <div class="home-container" id="analyticsPage">
            <div class="form-group">
                <h2 class="page-title">Analytics</h2>
                <p class="page-subtitle">System-wide analytics and insights</p>
            </div>
            <div style="padding: 60px 20px; text-align: center; color: #64748b;">
                <i class="fas fa-chart-bar" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3>Analytics Coming Soon</h3>
                <p>This section will display system-wide analytics and insights.</p>
            </div>
        </div>

        <!-- Notifications Page -->
        <div class="home-container" id="notificationsPage">
            <div class="form-group">
                <h2 class="page-title">Notifications</h2>
                <p class="page-subtitle">System alerts and updates</p>
            </div>
            <div style="padding: 60px 20px; text-align: center; color: #64748b;">
                <i class="fas fa-bell" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3>No Notifications</h3>
                <p>You're all caught up! No new notifications at this time.</p>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="home-container" id="settingsPage">
            <div class="form-group">
                <h2 class="page-title">Settings</h2>
                <p class="page-subtitle">Customize your experience</p>
            </div>
            <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
                <div
                    style="background: white; border-radius: 12px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin-bottom: 20px; color: #1f2937;">Appearance</h3>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #e5e7eb;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">Dark Mode</div>
                            <div style="font-size: 0.85rem; color: #64748b;">Toggle between light and dark theme</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail Section -->
        <div class="home-container" id="detailPage">

            <!-- Right Sidebar Navigation -->


            <!-- PC Status Card -->
            <div class="pc-status-container" id="pcStatusContainer" style="display:none;">
                <div class="pc-status-card">

                    <div class="pc-status-header">
                        <div class="status-indicator-wrapper">
                            <div class="status-indicator" id="statusIndicator"></div>
                        </div>
                        <div class="pc-info">
                            <h2 id="pcDisplayName"></h2>
                            <div class="status-text" id="pcStatusText">
                                <i class="fas fa-circle"></i>
                                <span>Loading...</span>
                            </div>

                        </div>
                    </div>
                    <div class="system-info-grid" id="systemInfoGrid">
                        <!-- System info will be populated here -->
                    </div>

                    <!-- Shareable Link Section -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <label
                                style="font-size: 0.85rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-link"></i> Direct Link:
                            </label>
                            <input type="text" id="shareableLink" readonly
                                style="flex: 1; min-width: 200px; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background: #f8fafc; color: #374151;"
                                value="">
                            <button onclick="copyLink()"
                                style="padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        <p style="margin-top: 8px; font-size: 0.75rem; color: #64748b; font-style: italic;">
                            <i class="fas fa-info-circle"></i> Use this link for RFID tags or QR codes
                        </p>
                    </div>

                    <div id="statsGrid" class="stats-grid" style="display: none;"></div>

                    <!-- Anchor for scrolling to tabs -->
                    <div id="tabs-start-anchor" style="position: relative; top: -70px; visibility: hidden; height: 0;">
                    </div>

                    <div class="tabs-nav"
                        style="position: sticky; top: 60px; z-index: 1001; background: var(--container-bg); display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--card-border); padding: 10px 0; transition: all 0.3s ease;">

                        <button class="tab-btn active" onclick="switchTab('apps')" id="tab-btn-apps"
                            style="padding: 10px 20px; background: none; border: none; font-weight: 600; color: #4f46e5; border-bottom: 2px solid #4f46e5; cursor: pointer;">
                            <i class="fas fa-window-maximize"></i> App Usage
                        </button>
                        <button class="tab-btn" onclick="switchTab('browser')" id="tab-btn-browser"
                            style="padding: 10px 20px; background: none; border: none; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer;">
                            <i class="fas fa-search"></i> Browser Searches
                        </button>
                        <button class="tab-btn" onclick="switchTab('processes')" id="tab-btn-processes"
                            style="padding: 10px 20px; background: none; border: none; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer;">
                            <i class="fas fa-tasks"></i> Performance
                        </button>
                        <button class="tab-btn" onclick="switchTab('temperature')" id="tab-btn-temperature"
                            style="padding: 10px 20px; background: none; border: none; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer;">
                            <i class="fas fa-thermometer-half"></i> Temperature
                        </button>
                        <button class="tab-btn" onclick="switchTab('power')" id="tab-btn-power"
                            style="padding: 10px 20px; background: none; border: none; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer;">
                            <i class="fas fa-bolt"></i> Power & Voltage
                        </button>
                    </div>

                    <div id="browser-tab" class="tab-content" style="display: none;">
                        <div class="card" id="topSearchList"
                            style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                            <div class="chart-title"
                                style="text-align: left; margin-bottom: 15px; color: var(--text-heading);">
                                <i class="fas fa-arrow-trend-up"></i> Recent Sites Visited
                            </div>
                            <div id="topSearchListBody">
                                <div style="text-align: center; color: #9ca3af;">No data yet</div>
                            </div>
                        </div>
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>URL</th>
                                        <th>Search Engine</th>
                                        <th>Query</th>
                                    </tr>
                                </thead>
                                <tbody id="searchTableBody">
                                    <!-- Search data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls for Search -->
                        <div class="pagination" id="searchPaginationControls" style="display: none;">
                            <button class="pagination-btn" id="searchPrevBtn" onclick="changeSearchPage(-1)">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <div class="pagination-page-numbers" id="searchPageNumbers"></div>
                            <div class="pagination-info" id="searchPaginationInfo"></div>
                            <button class="pagination-btn" id="searchNextBtn" onclick="changeSearchPage(1)">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div id="apps-tab" class="tab-content" style="display: none;">
                        <div class="chart-container">
                            <div class="chart-title">App Usage Distribution</div>
                            <div class="chart-wrapper">
                                <canvas id="appUsageChart"></canvas>
                            </div>
                        </div>
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Application</th>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Duration</th>
                                        <th>Memory</th>
                                        <th>CPU</th>
                                    </tr>
                                </thead>
                                <tbody id="appTableBody">
                                    <!-- App data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls -->
                        <div class="pagination" id="paginationControls" style="display: none;">
                            <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <div class="pagination-page-numbers" id="pageNumbers"></div>
                            <div class="pagination-info" id="paginationInfo"></div>
                            <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div id="processes-tab" class="tab-content" style="display: none;">
                        <div id="taskManagerSection" style="margin-top: 0; padding-top: 0; border-top: none;">
                            <div class="task-manager-header-section">
                                <h3 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 5px;">CPU
                                </h3>
                                <div class="cpu-info-header" id="cpuInfoHeader"
                                    style="font-size: 0.9rem; color: #64748b;">
                                    <span id="cpuModel">Loading...</span>
                                </div>
                            </div>

                            <div class="task-manager-graph-container">
                                <div class="graph-header">
                                    <span class="graph-label">% Utilization</span>
                                    <span class="graph-time-label">60 seconds</span>
                                </div>
                                <div class="graph-wrapper">
                                    <canvas id="cpuUtilizationChart"></canvas>
                                </div>
                            </div>

                            <div class="task-manager-stats-grid">
                                <div class="task-manager-stats-column">
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">Utilization</div>
                                        <div class="stat-value-large" id="cpuUtilization">0%</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">Speed</div>
                                        <div class="stat-value-large" id="cpuSpeed">0.00 GHz</div>
                                    </div>
                                </div>

                                <div class="task-manager-stats-column">
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">Base speed</div>
                                        <div class="stat-value" id="baseSpeed">-</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">Sockets</div>
                                        <div class="stat-value" id="sockets">-</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">Cores</div>
                                        <div class="stat-value" id="cores">-</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">Logical processors</div>
                                        <div class="stat-value" id="logicalProcessors">-</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">Virtualization</div>
                                        <div class="stat-value" id="virtualization">-</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">L1 cache</div>
                                        <div class="stat-value" id="l1Cache">-</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">L2 cache</div>
                                        <div class="stat-value" id="l2Cache">-</div>
                                    </div>
                                    <div class="task-manager-stat-item">
                                        <div class="stat-label">L3 cache</div>
                                        <div class="stat-value" id="l3Cache">-</div>
                                    </div>
                                </div>
                            </div>

                            <div class="task-manager-header-section" style="margin-top: 40px;">
                                <h3 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 5px;">
                                    Memory
                                </h3>
                            </div>

                            <div class="task-manager-graph-container">
                                <div class="graph-header">
                                    <span class="graph-label">Memory Usage (GB)</span>
                                    <span class="graph-time-label">60 seconds</span>
                                </div>
                                <div class="graph-wrapper">
                                    <canvas id="memoryUtilizationChart"></canvas>
                                </div>
                            </div>

                            <div class="task-manager-memory-stats">
                                <div class="task-manager-stat-item">
                                    <div class="stat-label">In use</div>
                                    <div class="stat-value-large" id="memoryInUse">0 GB</div>
                                </div>
                                <div class="task-manager-stat-item">
                                    <div class="stat-label">Available</div>
                                    <div class="stat-value-large" id="memoryAvailable">0 GB</div>
                                </div>
                                <div class="task-manager-stat-item">
                                    <div class="stat-label">Committed</div>
                                    <div class="stat-value" id="memoryCommitted">-</div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="temperature-tab" class="tab-content" style="display: none;">
                        <div class="chart-container">
                            <div class="chart-title">CPU Temperature (C)</div>
                            <div class="chart-wrapper">
                                <canvas id="temperatureChart"></canvas>
                            </div>
                        </div>
                        <div class="data-table" style="margin-top: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Temperature (C)</th>
                                    </tr>
                                </thead>
                                <tbody id="temperatureTableBody">
                                    <!-- Temperature data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls for Temperature -->
                        <div class="pagination" id="temperaturePaginationControls"
                            style="display: none; margin-top: 10px;">
                            <button class="pagination-btn" id="temperaturePrevBtn" onclick="changeTempPage(-1)">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <div class="pagination-page-numbers" id="temperaturePageNumbers"></div>
                            <div class="pagination-info" id="temperaturePaginationInfo"></div>
                            <button class="pagination-btn" id="temperatureNextBtn" onclick="changeTempPage(1)">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div id="power-tab" class="tab-content" style="display: none;">
                        <div class="chart-container">
                            <div class="chart-title">CPU Voltage & Power</div>
                            <div class="chart-wrapper">
                                <canvas id="powerVoltageChart"></canvas>
                            </div>
                        </div>
                        <div class="data-table" style="margin-top: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Voltage (V)</th>
                                        <th>Power (W)</th>
                                    </tr>
                                </thead>
                                <tbody id="powerVoltageTableBody">
                                    <!-- Power/Voltage data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls for Power/Voltage -->
                        <div class="pagination" id="powerPaginationControls" style="display: none; margin-top: 10px;">
                            <button class="pagination-btn" id="powerPrevBtn" onclick="changePowerPage(-1)">
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <div class="pagination-page-numbers" id="powerPageNumbers"></div>
                            <div class="pagination-info" id="powerPaginationInfo"></div>
                            <button class="pagination-btn" id="powerNextBtn" onclick="changePowerPage(1)">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div id="loadingMessage" class="loading">
                        Enter PC name and date to view activity data
                    </div>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
                <script>
                    // Supabase configuration
                    const SUPABASE_URL = 'https://uxhefdybgjluzkbodryd.supabase.co';
                    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4aGVmZHliZ2psdXprYm9kcnlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDExMzAsImV4cCI6MjA3NjM3NzEzMH0.jvFSOUUNiWvLFdPHplVuRgvKkvt2zlet6NA_x3mLaJM';
                    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    function sanitizePcNameInput(value) {
                        return (value || '').trim();
                    }

                    function buildCaseInsensitiveFilter(value) {
                        if (!value) return value;
                        return value
                            .replace(/\\/g, '\\\\')
                            .replace(/%/g, '\\%')
                            .replace(/_/g, '\\_');
                    }

                    async function fetchPcRowCaseInsensitive(tableName, pcNameFilter) {
                        if (!pcNameFilter) return null;
                        const { data, error } = await supabase
                            .from(tableName)
                            .select('*')
                            .ilike('pc_name', pcNameFilter)
                            .limit(1);
                        if (error) throw error;
                        return data && data.length ? data[0] : null;
                    }

                    // Set today's date as default
                    document.getElementById('selectedDate').value = new Date().toISOString().split('T')[0];

                    let appChart = null;
                    let searchChart = null;
                    let cpuChart = null;
                    let memoryChart = null;
                    let temperatureChart = null;
                    let powerVoltageChart = null;
                    let taskManagerRefreshInterval = null;
                    let autoRefreshInterval = null;
                    let pcStatusRefreshInterval = null;
                    let lastUpdateTime = null;
                    const PC_STATUS_REFRESH_INTERVAL = 5000; // 5 seconds for PC status
                    const FULL_REFRESH_INTERVAL = 5000; // 5 seconds for full data reload
                    const TASK_MANAGER_REFRESH_INTERVAL = 1000; // 1 second for task manager

                    // Pagination variables
                    let allAppData = [];
                    let currentPage = 1;
                    let allSearchData = [];
                    let currentSearchPage = 1;
                    let allPowerVoltageData = [];
                    let currentPowerPage = 1;
                    let allTempData = [];
                    let currentTempPage = 1;
                    const itemsPerPage = 10; // Show 10 items per page

                    // Auto-refresh functionality
                    // PC status updates every 5 seconds, full data reload every 20 seconds
                    function startAutoRefresh() {
                        // Clear any existing intervals
                        stopAutoRefresh();

                        const pcName = document.getElementById('pcName').value.trim();
                        if (!pcName) {
                            return; // Don't start if no PC name
                        }

                        // Show indicator immediately (if it exists)
                        const refreshIndicator = document.getElementById('refreshIndicator');
                        if (refreshIndicator) {
                            refreshIndicator.style.display = 'inline-flex';
                        }
                        updateLastUpdateTime();

                        // Start PC status refresh interval (every 5 seconds)
                        pcStatusRefreshInterval = setInterval(() => {
                            if (document.hidden) return;

                            const currentPcName = document.getElementById('pcName').value.trim();
                            if (currentPcName) {
                                console.log('Auto-refresh: Updating PC status...');
                                refreshPcStatusOnly(currentPcName);
                            } else {
                                stopAutoRefresh();
                            }
                        }, PC_STATUS_REFRESH_INTERVAL);

                        // Start full data refresh interval (every 5 seconds)
                        autoRefreshInterval = setInterval(() => {
                            if (document.hidden) return;

                            const currentPcName = document.getElementById('pcName').value.trim();
                            if (currentPcName) {
                                // Check if task manager is open
                                const taskManagerSection = document.getElementById('taskManagerSection');
                                const isTaskManagerOpen = taskManagerSection && taskManagerSection.style.display !== 'none';

                                if (!isTaskManagerOpen) {
                                    console.log('Auto-refresh: Silent data reload...');
                                    refreshDataOnly();
                                } else {
                                    console.log('Auto-refresh: Skipping data reload (task manager is open)');
                                }
                            } else {
                                stopAutoRefresh();
                            }
                        }, FULL_REFRESH_INTERVAL);

                        console.log('Auto-refresh started for PC:', pcName, '- PC status: 5s, Full reload: 5s');
                    }

                    // Silent data refresh - updates charts and tables without disrupting user view
                    async function refreshDataOnly() {
                        const pcNameInput = document.getElementById('pcName').value;
                        const pcName = sanitizePcNameInput(pcNameInput);
                        const pcNameFilter = buildCaseInsensitiveFilter(pcName);
                        const selectedDate = document.getElementById('selectedDate').value;

                        if (!pcName || !selectedDate) return;

                        try {
                            // Fetch data silently
                            const localStart = new Date(`${selectedDate}T00:00:00`);
                            const localEnd = new Date(`${selectedDate}T23:59:59.999`);
                            const startDate = localStart.toISOString();
                            const endDate = localEnd.toISOString();

                            // Fetch app usage data
                            const { data: appData } = await supabase
                                .from('app_usage_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('start_time', startDate)
                                .lte('start_time', endDate)
                                .order('start_time', { ascending: false });

                            // Fetch idle logs
                            const { data: idleData } = await supabase
                                .from('idle_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('start_time', startDate)
                                .lte('start_time', endDate)
                                .order('start_time', { ascending: false });

                            // Fetch browser search logs
                            const { data: searchData } = await supabase
                                .from('browser_search_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('timestamp', startDate)
                                .lte('timestamp', endDate)
                                .order('timestamp', { ascending: false });

                            // Fetch temperature logs
                            const { data: tempData } = await supabase
                                .from('temperature_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('created_at', startDate)
                                .lte('created_at', endDate)
                                .order('created_at', { ascending: true });

                            // Fetch power/voltage logs
                            const { data: powerVoltageData } = await supabase
                                .from('power_voltage_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('created_at', startDate)
                                .lte('created_at', endDate)
                                .order('created_at', { ascending: true });

                            // Merge app and idle data
                            let combinedData = [...(appData || [])];
                            if (idleData) {
                                const formattedIdleData = idleData.map(log => {
                                    let duration = log.duration_seconds;
                                    if (!duration && log.start_time && log.end_time) {
                                        const start = new Date(log.start_time);
                                        const end = new Date(log.end_time);
                                        duration = Math.round((end - start) / 1000);
                                    }
                                    return {
                                        ...log,
                                        app_name: 'System Idle',
                                        is_idle_session: true,
                                        duration_seconds: duration || 0
                                    };
                                });
                                combinedData = [...combinedData, ...formattedIdleData];
                            }
                            combinedData.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

                            // Update data arrays and preserve pagination state
                            updateAppDataSilently(combinedData);
                            updateSearchDataSilently(searchData || []);
                            updateTemperatureDataSilently(tempData || []);
                            updatePowerVoltageDataSilently(powerVoltageData || []);

                            // Update last update time
                            updateLastUpdateTime();
                        } catch (error) {
                            console.error('Error refreshing data:', error);
                        }
                    }

                    // Update app data without resetting pagination
                    function updateAppDataSilently(newData) {
                        const oldPage = currentPage;
                        allAppData = newData;

                        // Keep user on same page if possible
                        const totalPages = Math.ceil(allAppData.length / itemsPerPage);
                        if (oldPage > totalPages) {
                            currentPage = totalPages > 0 ? totalPages : 1;
                        }

                        // Update display
                        const tbody = document.getElementById('appTableBody');
                        if (tbody && tbody.closest('#apps-tab').style.display !== 'none') {
                            displayCurrentPage();
                        }

                        // Update chart if it exists
                        updateAppChartSilently(newData);

                        // Update stats
                        updateStatsSilently(newData);
                    }

                    // Update search data without resetting pagination
                    function updateSearchDataSilently(newData) {
                        const oldPage = currentSearchPage;
                        allSearchData = newData;

                        // Keep user on same page if possible
                        const totalPages = Math.ceil(allSearchData.length / itemsPerPage);
                        if (oldPage > totalPages) {
                            currentSearchPage = totalPages > 0 ? totalPages : 1;
                        }

                        // Update display
                        const tbody = document.getElementById('searchTableBody');
                        if (tbody && tbody.closest('#browser-tab').style.display !== 'none') {
                            displayCurrentSearchPage();
                        }

                        // Update top sites list
                        updateTopSearchList(newData);
                    }

                    // Update temperature data and chart
                    function updateTemperatureDataSilently(newData) {
                        if (!newData || newData.length === 0) return;

                        const chartCanvas = document.getElementById('temperatureChart');
                        if (!chartCanvas) return;

                        // Prepare data (keep time formatting consistent with tables)
                        const labels = newData.map(entry => formatTime(entry.created_at));
                        const data = newData.map(entry => entry.cpu_temperature);

                        // Update chart if exists, create if not
                        if (temperatureChart) {
                            temperatureChart.data.labels = labels;
                            temperatureChart.data.datasets[0].data = data;
                            temperatureChart.update('none'); // Use 'none' mode for instant update
                        } else {
                            // Chart doesn't exist yet, create it
                            createTemperatureChart(newData);
                        }

                        // Update table + pagination only if temperature tab is visible
                        allTempData = newData;
                        const tbody = document.getElementById('temperatureTableBody');
                        const controls = document.getElementById('temperaturePaginationControls');

                        if (tbody && controls) {
                            // Keep user on same page if possible
                            const totalPages = Math.ceil(allTempData.length / itemsPerPage);
                            if (currentTempPage > totalPages) {
                                currentTempPage = totalPages > 0 ? totalPages : 1;
                            }

                            if (tbody.closest('#temperature-tab').style.display !== 'none') {
                                displayCurrentTempPage();
                            }
                        }
                    }

                    // Update app chart without recreation
                    function updateAppChartSilently(appData) {
                        if (!appChart) return;

                        const appUsage = {};
                        appData.forEach(entry => {
                            if (entry && entry.app_name) {
                                if (!appUsage[entry.app_name]) {
                                    appUsage[entry.app_name] = 0;
                                }
                                appUsage[entry.app_name] += entry.duration_seconds || 0;
                            }
                        });

                        const labels = Object.keys(appUsage);
                        const data = Object.values(appUsage).map(seconds => Math.round(seconds / 60));
                        const backgroundColors = labels.map(label =>
                            label === 'System Idle' ? '#f59e0b' : '#4f46e5'
                        );

                        // Update chart data
                        appChart.data.labels = labels;
                        appChart.data.datasets[0].data = data;
                        appChart.data.datasets[0].backgroundColor = backgroundColors;
                        appChart.update('none');
                    }

                    // Update stats without full recreation
                    function updateStatsSilently(appData) {
                        const statsGrid = document.getElementById('statsGrid');
                        if (!statsGrid || statsGrid.style.display === 'none') return;

                        // Calculate stats
                        let totalSessions = appData.length;
                        let totalDuration = 0;
                        let idleSessions = 0;
                        const uniqueApps = new Set();

                        appData.forEach(entry => {
                            totalDuration += entry.duration_seconds || 0;
                            if (entry.is_idle_session) {
                                idleSessions++;
                            } else if (entry.app_name) {
                                uniqueApps.add(entry.app_name);
                            }
                        });

                        // Update DOM
                        const totalSessionsEl = document.getElementById('totalSessions');
                        const totalTimeEl = document.getElementById('totalTime');
                        const uniqueAppsEl = document.getElementById('uniqueApps');
                        const idleTimeEl = document.getElementById('idleTime');

                        if (totalSessionsEl) totalSessionsEl.textContent = totalSessions;
                        if (totalTimeEl) totalTimeEl.textContent = formatDuration(totalDuration);
                        if (uniqueAppsEl) uniqueAppsEl.textContent = uniqueApps.size;
                        if (idleTimeEl) idleTimeEl.textContent = idleSessions;
                    }

                    // Update power/voltage data and chart
                    function updatePowerVoltageDataSilently(newData) {
                        if (!newData || newData.length === 0) return;

                        const chartCanvas = document.getElementById('powerVoltageChart');
                        if (!chartCanvas) return;

                        // Update backing data set
                        allPowerVoltageData = newData;

                        // Prepare data (keep time formatting consistent with temperature)
                        const labels = newData.map(entry => formatTime(entry.created_at));
                        const voltageData = newData.map(entry => entry.cpu_voltage);
                        const powerData = newData.map(entry => entry.cpu_power);

                        // Update chart if exists, create if not
                        if (powerVoltageChart) {
                            powerVoltageChart.data.labels = labels;
                            powerVoltageChart.data.datasets[0].data = voltageData;
                            powerVoltageChart.data.datasets[1].data = powerData;
                            powerVoltageChart.update('none'); // Use 'none' mode for instant update
                        } else {
                            // Chart doesn't exist yet, create it
                            createPowerVoltageChart(newData);
                        }

                        // Update table + pagination only if power tab is visible
                        const tbody = document.getElementById('powerVoltageTableBody');
                        const controls = document.getElementById('powerPaginationControls');
                        if (!tbody || !controls) return;

                        if (!allPowerVoltageData || allPowerVoltageData.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="3" class="empty-state">
                                        <i class="fas fa-bolt"></i>
                                        <h3>No Power/Voltage Data</h3>
                                        <p>No power or voltage logs recorded for this date</p>
                                    </td>
                                </tr>`;
                            controls.style.display = 'none';
                            return;
                        }

                        const totalPages = Math.ceil(allPowerVoltageData.length / itemsPerPage);
                        if (currentPowerPage > totalPages) {
                            currentPowerPage = totalPages || 1;
                        }

                        if (tbody.closest('#power-tab').style.display !== 'none') {
                            displayCurrentPowerPage();
                        }
                    }


                    function stopAutoRefresh() {
                        if (autoRefreshInterval) {
                            clearInterval(autoRefreshInterval);
                            autoRefreshInterval = null;
                        }
                        if (pcStatusRefreshInterval) {
                            clearInterval(pcStatusRefreshInterval);
                            pcStatusRefreshInterval = null;
                        }
                        console.log('Auto-refresh stopped');
                        const refreshIndicator = document.getElementById('refreshIndicator');
                        if (refreshIndicator) {
                            refreshIndicator.style.display = 'none';
                        }
                    }

                    // Refresh only PC status (faster, every 5 seconds)
                    async function refreshPcStatusOnly(pcName) {
                        try {
                            const sanitizedPcName = sanitizePcNameInput(pcName);
                            const pcNameFilter = buildCaseInsensitiveFilter(sanitizedPcName);
                            let resolvedPcName = sanitizedPcName;
                            // Fetch PC status
                            let isOnline = false;
                            let statusData = null;
                            try {
                                statusData = await fetchPcRowCaseInsensitive('pc_status', pcNameFilter);
                                if (statusData) {
                                    isOnline = statusData.is_online || false;
                                    resolvedPcName = statusData.pc_name || resolvedPcName;
                                }
                            } catch (err) {
                                console.warn('Could not fetch PC status:', err);
                            }

                            // Fetch system info
                            let systemInfo = null;
                            try {
                                systemInfo = await fetchPcRowCaseInsensitive('system_info', pcNameFilter);
                                if (systemInfo && !resolvedPcName) {
                                    resolvedPcName = systemInfo.pc_name || resolvedPcName;
                                }
                            } catch (err) {
                                console.warn('Could not fetch system info:', err);
                            }

                            // Get selected date
                            const selectedDate = document.getElementById('selectedDate').value || new Date().toISOString().split('T')[0];

                            // Update PC status only
                            const displayName = resolvedPcName || sanitizedPcName;
                            updatePcStatus(displayName, isOnline, statusData, systemInfo, selectedDate);

                            // Update last update time
                            updateLastUpdateTime();
                        } catch (error) {
                            console.error('Error refreshing PC status:', error);
                        }
                    }

                    function updateLastUpdateTime() {
                        // Always use the browser's actual local time (no manual offset math)
                        const now = new Date();

                        const dateStr = now.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });

                        const timeStr = now.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: true
                        });

                        const lastUpdateElement = document.getElementById('lastUpdateTime');
                        if (lastUpdateElement) {
                            lastUpdateElement.textContent = `Last updated: ${dateStr}  ${timeStr}`;
                        }
                    }




                    // Get URL parameters
                    function getURLParams() {
                        const params = new URLSearchParams(window.location.search);
                        return {
                            pc: params.get('pc') || '',
                            date: params.get('date') || ''
                        };
                    }

                    // Update URL without reloading page
                    function updateURL(pcName, date) {
                        const url = new URL(window.location);
                        if (pcName) {
                            url.searchParams.set('pc', pcName);
                        }
                        if (date) {
                            url.searchParams.set('date', date);
                        }
                        window.history.pushState({}, '', url);
                    }

                    // Check for URL parameters on page load
                    function checkURLParams() {
                        const params = getURLParams();
                        if (params.pc) {
                            document.getElementById('pcName').value = params.pc;
                            if (params.date) {
                                document.getElementById('selectedDate').value = params.date;
                            } else {
                                // If no date in URL, use today's date
                                document.getElementById('selectedDate').value = new Date().toISOString().split('T')[0];
                            }
                            // Auto-load data
                            loadData();
                        }
                    }

                    function navigateToPC(pcName) {
                        if (!pcName) return;
                        const pcInput = document.getElementById('pcName');
                        pcInput.value = pcName;
                        const dateInput = document.getElementById('selectedDate');
                        if (!dateInput.value) {
                            dateInput.value = new Date().toISOString().split('T')[0];
                        }
                        loadData();
                    }

                    // Load all PCs for home page
                    async function loadAllPCs() {
                        const pcsGrid = document.getElementById('pcsGrid');
                        pcsGrid.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading PCs...</div>';

                        try {
                            // Fetch all PC statuses
                            const { data: pcStatuses, error: statusError } = await supabase
                                .from('pc_status')
                                .select('*')
                                .order('pc_name', { ascending: true });

                            if (statusError) {
                                console.warn('Could not fetch PC statuses:', statusError);
                            }

                            // Fetch all system info
                            const { data: systemInfos, error: systemError } = await supabase
                                .from('system_info')
                                .select('*')
                                .order('pc_name', { ascending: true });

                            if (systemError) {
                                console.warn('Could not fetch system info:', systemError);
                            }

                            // Combine data
                            const pcsMap = new Map();

                            // Add PC statuses
                            if (pcStatuses) {
                                pcStatuses.forEach(pc => {
                                    pcsMap.set(pc.pc_name, {
                                        pc_name: pc.pc_name,
                                        is_online: pc.is_online || false,
                                        last_seen: pc.last_seen,
                                        last_activity: pc.last_activity,
                                        systemInfo: null
                                    });
                                });
                            }

                            // Add system info
                            if (systemInfos) {
                                systemInfos.forEach(info => {
                                    if (pcsMap.has(info.pc_name)) {
                                        pcsMap.get(info.pc_name).systemInfo = info;
                                    } else {
                                        pcsMap.set(info.pc_name, {
                                            pc_name: info.pc_name,
                                            is_online: false,
                                            last_seen: null,
                                            last_activity: null,
                                            systemInfo: info
                                        });
                                    }
                                });
                            }

                            // Display PCs
                            if (pcsMap.size === 0) {
                                pcsGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-desktop"></i>
                            <h3>No PCs Found</h3>
                            <p>No PCs have been registered yet. Start the client application on a PC to register it.</p>
                        </div>
                    `;
                                return;
                            }

                            const pcsArray = Array.from(pcsMap.values());
                            pcsGrid.innerHTML = pcsArray.map(pc => {
                                const isOnline = pc.is_online;
                                const isIdle = pc.is_idle === true;

                                let statusClass, statusText, statusColor;
                                if (!isOnline) {
                                    statusClass = 'offline';
                                    statusText = 'Offline';
                                    statusColor = '#ef4444';
                                } else if (isIdle) {
                                    statusClass = 'idle';
                                    statusText = 'Idle';
                                    statusColor = '#f59e0b';
                                } else {
                                    statusClass = '';
                                    statusText = 'Online';
                                    statusColor = '#22c55e';
                                }

                                return `
                        <div class="pc-card" data-pc-name="${escapeHtml(pc.pc_name)}">
                            <div class="pc-card-header">
                                <div class="pc-card-status ${statusClass}"></div>
                                <div class="pc-card-name">${escapeHtml(pc.pc_name)}</div>
                            </div>
                            <div class="pc-card-info">
                                    <div class="pc-card-info-item">
                                    <span>Status:</span>
                                    <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                                </div>
                                ${pc.systemInfo && pc.systemInfo.cpu_model ? `
                                    <div class="pc-card-info-item">
                                        <span>CPU:</span>
                                        <span>${escapeHtml(pc.systemInfo.cpu_model)}</span>
                                    </div>
                                ` : ''}
                                ${pc.systemInfo && pc.systemInfo.total_memory_gb ? `
                                    <div class="pc-card-info-item">
                                        <span>RAM:</span>
                                        <span>${pc.systemInfo.total_memory_gb} GB</span>
                                    </div>
                                ` : ''}
                                ${pc.last_seen ? `
                                    <div class="pc-card-info-item">
                                        <span>Last Seen:</span>
                                        <span>${formatDateTime(pc.last_seen)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                            }).join('');

                        } catch (error) {
                            console.error('Error loading PCs:', error);
                            pcsGrid.innerHTML = `
                    <div class="error" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading PCs. Please check your connection and try again.
                    </div>
                `;
                        }
                    }

                    // Initialize on page load
                    window.addEventListener('DOMContentLoaded', () => {
                        loadAllPCs();
                        checkURLParams();

                        // Add event delegation for PC cards
                        const pcsGrid = document.getElementById('pcsGrid');
                        if (pcsGrid) {
                            pcsGrid.addEventListener('click', (e) => {
                                const card = e.target.closest('.pc-card');
                                if (card) {
                                    const pcName = card.getAttribute('data-pc-name');
                                    if (pcName) {
                                        navigateToPC(pcName);
                                    }
                                }
                            });
                        }
                    });

                    // Stop auto-refresh when page is hidden (tab switch)
                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden) {
                            stopAutoRefresh();
                        } else {
                            const pcName = document.getElementById('pcName').value.trim();
                            if (pcName) {
                                startAutoRefresh();
                            }
                        }
                    });

                    async function loadData() {
                        const pcNameInput = document.getElementById('pcName').value;
                        const pcName = sanitizePcNameInput(pcNameInput);
                        const pcNameFilter = buildCaseInsensitiveFilter(pcName);
                        let resolvedPcName = pcName;
                        let selectedDate = document.getElementById('selectedDate').value;

                        if (!pcName) {
                            alert('Please enter a PC name');
                            return;
                        }

                        // If no date selected, use today's date
                        if (!selectedDate) {
                            selectedDate = new Date().toISOString().split('T')[0];
                            document.getElementById('selectedDate').value = selectedDate;
                        }

                        // Update URL with current parameters
                        updateURL(pcName, selectedDate);

                        // Switch views
                        document.querySelectorAll('.home-container').forEach(el => el.classList.remove('active'));
                        const detailPage = document.getElementById('detailPage');
                        detailPage.classList.add('active');
                        detailPage.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        // Update navbar
                        document.getElementById('nav-home').classList.remove('active');
                        document.getElementById('nav-dashboard').classList.add('active');
                        document.getElementById('nav-dashboard').style.display = 'flex';
                        // navbarSubtitle removed - search inputs are in navbar now

                        // Show right sidebar
                        toggleRightSidebar(true);

                        // Update header and show loading state
                        const headerSubtitleEl = document.getElementById('headerSubtitle');
                        if (headerSubtitleEl) {
                            headerSubtitleEl.textContent = `PC: ${pcName || 'Unknown'}  ${selectedDate}`;
                        }
                        document.getElementById('loadingMessage').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading data...';
                        document.getElementById('loadingMessage').style.display = 'block';
                        document.getElementById('statsGrid').style.display = 'none';
                        document.getElementById('pcStatusContainer').style.display = 'none';
                        document.getElementById('apps-tab').style.display = 'none';
                        document.getElementById('temperature-tab').style.display = 'none';
                        document.getElementById('power-tab').style.display = 'none';
                        hideTaskManager();

                        try {
                            // Fetch PC status (handle case where table might not exist)
                            let isOnline = false;
                            let statusData = null;
                            try {
                                statusData = await fetchPcRowCaseInsensitive('pc_status', pcNameFilter);
                                if (statusData) {
                                    isOnline = statusData.is_online || false;
                                    resolvedPcName = statusData.pc_name || resolvedPcName;
                                }
                            } catch (err) {
                                // Table might not exist, use default offline status
                                console.warn('Could not fetch PC status:', err);
                            }

                            // Fetch system info
                            let systemInfo = null;
                            try {
                                systemInfo = await fetchPcRowCaseInsensitive('system_info', pcNameFilter);
                                if (systemInfo && !resolvedPcName) {
                                    resolvedPcName = systemInfo.pc_name || resolvedPcName;
                                }
                            } catch (err) {
                                console.warn('Could not fetch system info:', err);
                            }

                            const displayPcName = resolvedPcName || pcName;
                            if (headerSubtitleEl) {
                                headerSubtitleEl.textContent = `PC: ${displayPcName || 'Unknown'}  ${selectedDate}`;
                            }
                            updatePcStatus(displayPcName, isOnline, statusData, systemInfo, selectedDate);

                            // Fetch app usage data
                            // Convert selected date to UTC date range for proper querying
                            // The selected date is in local timezone, but we need to query UTC
                            // Create start of day in local timezone, then convert to UTC
                            const localStart = new Date(`${selectedDate}T00:00:00`);
                            const localEnd = new Date(`${selectedDate}T23:59:59.999`);
                            // Convert to UTC ISO strings for database query
                            const startDate = localStart.toISOString();
                            const endDate = localEnd.toISOString();

                            const { data: appData, error: appError } = await supabase
                                .from('app_usage_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('start_time', startDate)
                                .lte('start_time', endDate)
                                .order('start_time', { ascending: false });

                            if (appError) {
                                console.error('App data error:', appError);
                                throw appError;
                            }

                            // Fetch idle logs
                            const { data: idleData, error: idleError } = await supabase
                                .from('idle_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('start_time', startDate)
                                .lte('start_time', endDate)
                                .order('start_time', { ascending: false });

                            if (idleError) {
                                console.warn('Idle data error:', idleError);
                                // Don't throw, just continue without idle data
                            }

                            // Fetch browser search logs
                            const { data: searchData, error: searchError } = await supabase
                                .from('browser_search_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('timestamp', startDate)
                                .lte('timestamp', endDate)
                                .order('timestamp', { ascending: false });

                            if (searchError) {
                                console.warn('Search data error:', searchError);
                            }

                            // Fetch temperature logs
                            const { data: tempData, error: tempError } = await supabase
                                .from('temperature_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('created_at', startDate)
                                .lte('created_at', endDate)
                                .order('created_at', { ascending: true });

                            if (tempError) {
                                console.warn('Temperature data error:', tempError);
                            }

                            // Fetch power/voltage logs
                            const { data: powerVoltageData, error: powerVoltageError } = await supabase
                                .from('power_voltage_logs')
                                .select('*')
                                .ilike('pc_name', pcNameFilter)
                                .gte('created_at', startDate)
                                .lte('created_at', endDate)
                                .order('created_at', { ascending: true });

                            if (powerVoltageError) {
                                console.warn('Power/Voltage data error:', powerVoltageError);
                            }

                            // Merge and sort data
                            let combinedData = [...(appData || [])];
                            if (idleData) {
                                const formattedIdleData = idleData.map(log => {
                                    let duration = log.duration_seconds;
                                    if (!duration && log.start_time && log.end_time) {
                                        const start = new Date(log.start_time);
                                        const end = new Date(log.end_time);
                                        duration = Math.round((end - start) / 1000);
                                    }
                                    return {
                                        ...log,
                                        app_name: 'System Idle',
                                        is_idle_session: true,
                                        duration_seconds: duration || 0
                                    };
                                });
                                combinedData = [...combinedData, ...formattedIdleData];
                            }

                            // Sort by start time descending
                            combinedData.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

                            // Process and display data
                            processData(combinedData);
                            processSearchData(searchData || []);
                            processTemperatureData(tempData || []);
                            processPowerVoltageData(powerVoltageData || []);

                            // Update last update time
                            updateLastUpdateTime();

                            // Start auto-refresh (will reload data every 5 seconds)
                            // Only start if not already running (to avoid multiple intervals)
                            if (!autoRefreshInterval) {
                                startAutoRefresh();
                            }

                        } catch (error) {
                            console.error('Error loading data:', error);
                            document.getElementById('loadingMessage').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i>
                        Error loading data. Please check your connection and try again.
                    </div>`;
                        }
                    }

                    function processData(appData) {
                        console.log('Processing data:', appData.length, 'entries');

                        // Calculate stats
                        const totalAppSessions = appData.length;
                        const totalAppTime = appData.reduce((sum, row) => sum + (row.duration_seconds || 0), 0);

                        // Update stats grid
                        const statsGrid = document.getElementById('statsGrid');
                        if (statsGrid) {
                            statsGrid.innerHTML = `
                    <div class="stat-card" id="appSessionsCard" onclick="toggleAppSessionsBreakdown()" style="cursor: pointer;">
                    <i class="fas fa-desktop"></i>
                        <div class="number">${totalAppSessions}</div>
                        <div class="label">App Sessions</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock"></i>
                        <div class="number">${formatDuration(totalAppTime)}</div>
                        <div class="label">Total Usage</div>
                </div>
                    <div id="appSessionsBreakdown" style="grid-column: 1 / -1; display: none; margin-top: 10px;">
                        <!-- Breakdown content injected here -->
                </div>
            `;
                            statsGrid.style.display = 'grid';
                        }

                        // Populate tables
                        populateAppTable(appData);

                        // Create/update charts
                        createAppChart(appData);

                        // Show content (only hide loading message if it exists)
                        const loadingMessage = document.getElementById('loadingMessage');
                        if (loadingMessage) {
                            loadingMessage.style.display = 'none';
                        }

                        const appsTab = document.getElementById('apps-tab');
                        if (appsTab) {
                            appsTab.style.display = 'block';
                        }

                        console.log('Data processed and displayed');

                        // Show only the App Usage tab by default
                        switchTab('apps');
                    }

                    function toggleAppSessionsBreakdown() {
                        const breakdownEl = document.getElementById('appSessionsBreakdown');
                        if (!breakdownEl) return;
                        if (breakdownEl.style.display === 'none' || breakdownEl.style.display === '') {
                            // Build breakdown content
                            const counts = computeAppSessionCounts();
                            if (counts.length === 0) {
                                breakdownEl.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-info-circle"></i>
                            <h3>No sessions to summarize</h3>
                        </div>
                    `;
                            } else {
                                const total = counts.reduce((s, c) => s + c.count, 0);
                                breakdownEl.innerHTML = `
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Application</th>
                                        <th>Sessions</th>
                                        <th>Share</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${counts.map(({ name, count }) => {
                                    const pct = total ? Math.round((count / total) * 100) : 0;
                                    return `
                                            <tr>
                                                <td>${escapeHtml(name)}</td>
                                                <td>${count}</td>
                                                <td>${pct}%</td>
                                            </tr>
                                        `;
                                }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                            }
                            breakdownEl.style.display = 'block';
                        } else {
                            breakdownEl.style.display = 'none';
                        }
                    }

                    function computeAppSessionCounts() {
                        try {
                            const map = new Map();
                            (allAppData || []).forEach(entry => {
                                const name = entry && entry.app_name ? String(entry.app_name) : 'Unknown';
                                map.set(name, (map.get(name) || 0) + 1);
                            });
                            // Sort by count desc, then name asc
                            return Array.from(map.entries())
                                .map(([name, count]) => ({ name, count }))
                                .sort((a, b) => b.count - a.count || a.name.localeCompare(b.name));
                        } catch {
                            return [];
                        }
                    }

                    function processTemperatureData(tempData) {
                        // Create/update chart
                        createTemperatureChart(tempData);

                        // Store data for pagination
                        const tbody = document.getElementById('temperatureTableBody');
                        const controls = document.getElementById('temperaturePaginationControls');
                        if (!tbody || !controls) return;

                        allTempData = tempData || [];
                        currentTempPage = 1;

                        if (!allTempData.length) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="2" class="empty-state">
                                        <i class="fas fa-thermometer-half"></i>
                                        <h3>No Temperature Data</h3>
                                        <p>No CPU temperature logs recorded for this date</p>
                                    </td>
                                </tr>`;
                            controls.style.display = 'none';
                            return;
                        }

                        // Show pagination if more than itemsPerPage
                        if (allTempData.length > itemsPerPage) {
                            controls.style.display = 'flex';
                        } else {
                            controls.style.display = 'none';
                        }

                        // Render first page
                        displayCurrentTempPage();
                    }

                    function displayCurrentTempPage() {
                        const tbody = document.getElementById('temperatureTableBody');
                        if (!tbody) return;

                        const startIndex = (currentTempPage - 1) * itemsPerPage;
                        const endIndex = startIndex + itemsPerPage;
                        const pageData = allTempData.slice(startIndex, endIndex);

                        tbody.innerHTML = pageData.map(entry => {
                            const ts = formatTime(entry.created_at || entry.timestamp);
                            const t = (entry.cpu_temperature !== null && entry.cpu_temperature !== undefined)
                                ? entry.cpu_temperature.toFixed(1)
                                : 'N/A';
                            return `
                                <tr>
                                    <td>${ts}</td>
                                    <td>${t}</td>
                                </tr>
                            `;
                        }).join('');

                        updateTempPagination();
                    }

                    function updateTempPagination() {
                        const totalPages = Math.ceil(allTempData.length / itemsPerPage);
                        const info = document.getElementById('temperaturePaginationInfo');
                        const prevBtn = document.getElementById('temperaturePrevBtn');
                        const nextBtn = document.getElementById('temperatureNextBtn');
                        const pageNumbers = document.getElementById('temperaturePageNumbers');

                        if (!info || !prevBtn || !nextBtn || !pageNumbers) return;

                        const startItem = (currentTempPage - 1) * itemsPerPage + 1;
                        const endItem = Math.min(currentTempPage * itemsPerPage, allTempData.length);
                        info.textContent = `Showing ${startItem}-${endItem} of ${allTempData.length}`;

                        prevBtn.disabled = currentTempPage === 1;
                        nextBtn.disabled = currentTempPage === totalPages;

                        pageNumbers.innerHTML = '';
                        const maxVisiblePages = 5;
                        let startPage = Math.max(1, currentTempPage - Math.floor(maxVisiblePages / 2));
                        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                        if (endPage - startPage < maxVisiblePages - 1) {
                            startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }

                        if (startPage > 1) {
                            const firstBtn = document.createElement('button');
                            firstBtn.className = 'page-number';
                            firstBtn.textContent = '1';
                            firstBtn.onclick = () => goToTempPage(1);
                            pageNumbers.appendChild(firstBtn);

                            if (startPage > 2) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }
                        }

                        for (let i = startPage; i <= endPage; i++) {
                            const pageBtn = document.createElement('button');
                            pageBtn.className = 'page-number' + (i === currentTempPage ? ' active' : '');
                            pageBtn.textContent = i;
                            pageBtn.onclick = () => goToTempPage(i);
                            pageNumbers.appendChild(pageBtn);
                        }

                        if (endPage < totalPages) {
                            if (endPage < totalPages - 1) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }

                            const lastBtn = document.createElement('button');
                            lastBtn.className = 'page-number';
                            lastBtn.textContent = totalPages;
                            lastBtn.onclick = () => goToTempPage(totalPages);
                            pageNumbers.appendChild(lastBtn);
                        }
                    }

                    function changeTempPage(direction) {
                        const totalPages = Math.ceil(allTempData.length / itemsPerPage);
                        const newPage = currentTempPage + direction;
                        if (newPage >= 1 && newPage <= totalPages) {
                            currentTempPage = newPage;
                            displayCurrentTempPage();
                            document.getElementById('temperatureTableBody')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }

                    function goToTempPage(page) {
                        const totalPages = Math.ceil(allTempData.length / itemsPerPage);
                        if (page >= 1 && page <= totalPages) {
                            currentTempPage = page;
                            displayCurrentTempPage();
                            document.getElementById('temperatureTableBody')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }

                    function createTemperatureChart(tempData) {
                        const chartCanvas = document.getElementById('temperatureChart');
                        if (!chartCanvas) {
                            console.warn('Temperature chart canvas not found');
                            return;
                        }

                        const ctx = chartCanvas.getContext('2d');

                        // Destroy existing chart if it exists
                        if (temperatureChart) {
                            temperatureChart.destroy();
                            temperatureChart = null;
                        }

                        if (!tempData || tempData.length === 0) {
                            // Show empty state or just return
                            return;
                        }

                        // Prepare data (use same time formatting as tables)
                        const labels = tempData.map(entry => formatTime(entry.created_at));
                        const data = tempData.map(entry => entry.cpu_temperature);

                        temperatureChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'CPU Temperature (C)',
                                    data: data,
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0,
                                    pointHoverRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index',
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        suggestedMin: 30,
                                        suggestedMax: 120,
                                        title: {
                                            display: true,
                                            text: 'Temperature (C)'
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            maxTicksLimit: 12
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                return `Temperature: ${context.parsed.y.toFixed(1)}C`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }

                    function processPowerVoltageData(powerVoltageData) {
                        // Create/update chart
                        createPowerVoltageChart(powerVoltageData);

                        // Store data for pagination
                        const tbody = document.getElementById('powerVoltageTableBody');
                        const controls = document.getElementById('powerPaginationControls');
                        if (!tbody || !controls) return;

                        allPowerVoltageData = powerVoltageData || [];
                        currentPowerPage = 1;

                        if (!allPowerVoltageData.length) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="3" class="empty-state">
                                        <i class="fas fa-bolt"></i>
                                        <h3>No Power/Voltage Data</h3>
                                        <p>No power or voltage logs recorded for this date</p>
                                    </td>
                                </tr>`;
                            controls.style.display = 'none';
                            return;
                        }

                        // Show pagination if more than itemsPerPage
                        if (allPowerVoltageData.length > itemsPerPage) {
                            controls.style.display = 'flex';
                        } else {
                            controls.style.display = 'none';
                        }

                        // Render first page
                        displayCurrentPowerPage();
                    }

                    function displayCurrentPowerPage() {
                        const tbody = document.getElementById('powerVoltageTableBody');
                        if (!tbody) return;

                        const startIndex = (currentPowerPage - 1) * itemsPerPage;
                        const endIndex = startIndex + itemsPerPage;
                        const pageData = allPowerVoltageData.slice(startIndex, endIndex);

                        tbody.innerHTML = pageData.map(entry => {
                            const ts = formatTime(entry.created_at || entry.timestamp);
                            const v = (entry.cpu_voltage !== null && entry.cpu_voltage !== undefined)
                                ? entry.cpu_voltage.toFixed(3)
                                : 'N/A';
                            const p = (entry.cpu_power !== null && entry.cpu_power !== undefined)
                                ? entry.cpu_power.toFixed(1)
                                : 'N/A';
                            return `
                                <tr>
                                    <td>${ts}</td>
                                    <td>${v}</td>
                                    <td>${p}</td>
                                </tr>
                            `;
                        }).join('');

                        updatePowerPagination();
                    }

                    function updatePowerPagination() {
                        const totalPages = Math.ceil(allPowerVoltageData.length / itemsPerPage);
                        const info = document.getElementById('powerPaginationInfo');
                        const prevBtn = document.getElementById('powerPrevBtn');
                        const nextBtn = document.getElementById('powerNextBtn');
                        const pageNumbers = document.getElementById('powerPageNumbers');

                        if (!info || !prevBtn || !nextBtn || !pageNumbers) return;

                        const startItem = (currentPowerPage - 1) * itemsPerPage + 1;
                        const endItem = Math.min(currentPowerPage * itemsPerPage, allPowerVoltageData.length);
                        info.textContent = `Showing ${startItem}-${endItem} of ${allPowerVoltageData.length}`;

                        prevBtn.disabled = currentPowerPage === 1;
                        nextBtn.disabled = currentPowerPage === totalPages;

                        pageNumbers.innerHTML = '';
                        const maxVisiblePages = 5;
                        let startPage = Math.max(1, currentPowerPage - Math.floor(maxVisiblePages / 2));
                        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                        if (endPage - startPage < maxVisiblePages - 1) {
                            startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }

                        if (startPage > 1) {
                            const firstBtn = document.createElement('button');
                            firstBtn.className = 'page-number';
                            firstBtn.textContent = '1';
                            firstBtn.onclick = () => goToPowerPage(1);
                            pageNumbers.appendChild(firstBtn);

                            if (startPage > 2) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }
                        }

                        for (let i = startPage; i <= endPage; i++) {
                            const pageBtn = document.createElement('button');
                            pageBtn.className = 'page-number' + (i === currentPowerPage ? ' active' : '');
                            pageBtn.textContent = i;
                            pageBtn.onclick = () => goToPowerPage(i);
                            pageNumbers.appendChild(pageBtn);
                        }

                        if (endPage < totalPages) {
                            if (endPage < totalPages - 1) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }

                            const lastBtn = document.createElement('button');
                            lastBtn.className = 'page-number';
                            lastBtn.textContent = totalPages;
                            lastBtn.onclick = () => goToPowerPage(totalPages);
                            pageNumbers.appendChild(lastBtn);
                        }
                    }

                    function changePowerPage(direction) {
                        const totalPages = Math.ceil(allPowerVoltageData.length / itemsPerPage);
                        const newPage = currentPowerPage + direction;
                        if (newPage >= 1 && newPage <= totalPages) {
                            currentPowerPage = newPage;
                            displayCurrentPowerPage();
                            document.getElementById('powerVoltageTableBody')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }

                    function goToPowerPage(page) {
                        const totalPages = Math.ceil(allPowerVoltageData.length / itemsPerPage);
                        if (page >= 1 && page <= totalPages) {
                            currentPowerPage = page;
                            displayCurrentPowerPage();
                            document.getElementById('powerVoltageTableBody')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }

                    function createPowerVoltageChart(powerVoltageData) {
                        const chartCanvas = document.getElementById('powerVoltageChart');
                        if (!chartCanvas) {
                            console.warn('Power/Voltage chart canvas not found');
                            return;
                        }

                        const ctx = chartCanvas.getContext('2d');

                        // Destroy existing chart if it exists
                        if (powerVoltageChart) {
                            powerVoltageChart.destroy();
                            powerVoltageChart = null;
                        }

                        if (!powerVoltageData || powerVoltageData.length === 0) {
                            // Show empty state or just return
                            return;
                        }

                        // Prepare data (use same time formatting as temperature)
                        const labels = powerVoltageData.map(entry => formatTime(entry.created_at));
                        const voltageData = powerVoltageData.map(entry => entry.cpu_voltage);
                        const powerData = powerVoltageData.map(entry => entry.cpu_power);

                        powerVoltageChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'CPU Voltage (V)',
                                        data: voltageData,
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 0,
                                        pointHoverRadius: 4,
                                        yAxisID: 'y'
                                    },
                                    {
                                        label: 'CPU Power (W)',
                                        data: powerData,
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 0,
                                        pointHoverRadius: 4,
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index',
                                },
                                scales: {
                                    y: {
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        beginAtZero: false,
                                        suggestedMin: 0.8,
                                        suggestedMax: 1.6,
                                        title: {
                                            display: true,
                                            text: 'Voltage (V)'
                                        },
                                        ticks: {
                                            color: '#10b981'
                                        }
                                    },
                                    y1: {
                                        type: 'linear',
                                        display: true,
                                        position: 'right',
                                        beginAtZero: false,
                                        suggestedMin: 0,
                                        suggestedMax: 150,
                                        title: {
                                            display: true,
                                            text: 'Power (W)'
                                        },
                                        ticks: {
                                            color: '#f59e0b'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            maxTicksLimit: 12
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function (context) {
                                                const label = context.dataset.label || '';
                                                const value = context.parsed.y;
                                                if (label.includes('Voltage')) {
                                                    return `${label}: ${value.toFixed(3)}V`;
                                                } else {
                                                    return `${label}: ${value.toFixed(1)}W`;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }

                    function populateAppTable(appData) {
                        const tbody = document.getElementById('appTableBody');
                        const paginationControls = document.getElementById('paginationControls');

                        // Store all data for pagination
                        allAppData = appData;
                        currentPage = 1;

                        if (appData.length === 0) {
                            tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-desktop"></i>
                            <h3>No App Usage Data</h3>
                            <p>No application usage recorded for this date</p>
                        </td>
                    </tr>`;
                            paginationControls.style.display = 'none';
                            return;
                        }

                        // Show pagination if more than itemsPerPage
                        if (appData.length > itemsPerPage) {
                            paginationControls.style.display = 'flex';
                            updatePagination();
                        } else {
                            paginationControls.style.display = 'none';
                        }

                        // Display current page
                        displayCurrentPage();
                    }

                    function displayCurrentPage() {
                        const tbody = document.getElementById('appTableBody');
                        const startIndex = (currentPage - 1) * itemsPerPage;
                        const endIndex = startIndex + itemsPerPage;
                        const pageData = allAppData.slice(startIndex, endIndex);

                        tbody.innerHTML = pageData.map(entry => {
                            const duration = formatDuration(entry.duration_seconds || 0);
                            const memory = entry.memory_usage_bytes ? formatBytes(entry.memory_usage_bytes) : 'N/A';
                            const cpu = entry.cpu_percent ? `${Math.round(entry.cpu_percent)}%` : 'N/A';

                            const isIdle = entry.is_idle_session;
                            const rowStyle = isIdle ? 'style="background-color: #fffbeb;"' : '';
                            const icon = isIdle ? '<i class="fas fa-moon" style="color: #f59e0b; margin-right: 8px;"></i>' : '';

                            return `
                    <tr ${rowStyle}>
                        <td>${icon}${escapeHtml(entry.app_name)}</td>
                        <td>${formatTime(entry.start_time)}</td>
                        <td>${formatTime(entry.end_time)}</td>
                        <td>${duration}</td>
                        <td>${memory}</td>
                        <td>${cpu}</td>
                    </tr>
                `;
                        }).join('');

                        updatePagination();
                    }

                    function updatePagination() {
                        const totalPages = Math.ceil(allAppData.length / itemsPerPage);
                        const paginationInfo = document.getElementById('paginationInfo');
                        const prevBtn = document.getElementById('prevBtn');
                        const nextBtn = document.getElementById('nextBtn');
                        const pageNumbers = document.getElementById('pageNumbers');

                        // Update info
                        const startItem = (currentPage - 1) * itemsPerPage + 1;
                        const endItem = Math.min(currentPage * itemsPerPage, allAppData.length);
                        paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${allAppData.length}`;

                        // Update buttons
                        prevBtn.disabled = currentPage === 1;
                        nextBtn.disabled = currentPage === totalPages;

                        // Update page numbers
                        pageNumbers.innerHTML = '';
                        const maxVisiblePages = 5;
                        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                        if (endPage - startPage < maxVisiblePages - 1) {
                            startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }

                        if (startPage > 1) {
                            const firstBtn = document.createElement('button');
                            firstBtn.className = 'page-number';
                            firstBtn.textContent = '1';
                            firstBtn.onclick = () => goToPage(1);
                            pageNumbers.appendChild(firstBtn);

                            if (startPage > 2) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }
                        }

                        for (let i = startPage; i <= endPage; i++) {
                            const pageBtn = document.createElement('button');
                            pageBtn.className = 'page-number' + (i === currentPage ? ' active' : '');
                            pageBtn.textContent = i;
                            pageBtn.onclick = () => goToPage(i);
                            pageNumbers.appendChild(pageBtn);
                        }

                        if (endPage < totalPages) {
                            if (endPage < totalPages - 1) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }

                            const lastBtn = document.createElement('button');
                            lastBtn.className = 'page-number';
                            lastBtn.textContent = totalPages;
                            lastBtn.onclick = () => goToPage(totalPages);
                            pageNumbers.appendChild(lastBtn);
                        }
                    }

                    function changePage(direction) {
                        const totalPages = Math.ceil(allAppData.length / itemsPerPage);
                        const newPage = currentPage + direction;

                        if (newPage >= 1 && newPage <= totalPages) {
                            currentPage = newPage;
                            displayCurrentPage();
                            // Scroll to top of table
                            document.getElementById('appTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }

                    function goToPage(page) {
                        const totalPages = Math.ceil(allAppData.length / itemsPerPage);
                        if (page >= 1 && page <= totalPages) {
                            currentPage = page;
                            displayCurrentPage();
                            // Scroll to top of table
                            document.getElementById('appTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }


                    function createAppChart(appData) {
                        const chartCanvas = document.getElementById('appUsageChart');
                        if (!chartCanvas) {
                            console.warn('Chart canvas not found');
                            return;
                        }

                        const ctx = chartCanvas.getContext('2d');
                        const appUsage = {};

                        appData.forEach(entry => {
                            if (entry && entry.app_name) {
                                if (!appUsage[entry.app_name]) {
                                    appUsage[entry.app_name] = 0;
                                }
                                appUsage[entry.app_name] += entry.duration_seconds || 0;
                            }
                        });

                        // Destroy existing chart if it exists
                        if (appChart) {
                            appChart.destroy();
                            appChart = null;
                        }

                        // Create new chart
                        const labels = Object.keys(appUsage);
                        const data = Object.values(appUsage).map(seconds => Math.round(seconds / 60));

                        // Generate colors
                        const backgroundColors = labels.map(label =>
                            label === 'System Idle' ? '#f59e0b' : '#4f46e5'
                        );

                        if (labels.length === 0) {
                            console.log('No app data to display in chart');
                            return;
                        }

                        appChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Usage Time (minutes)',
                                    data: data,
                                    backgroundColor: backgroundColors
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                },
                                animation: {
                                    duration: 300
                                }
                            }
                        });

                        console.log('Chart updated with', labels.length, 'apps');
                    }

                    function processSearchData(searchData) {
                        // Store all data for pagination
                        allSearchData = searchData;
                        currentSearchPage = 1;

                        const paginationControls = document.getElementById('searchPaginationControls');
                        const tbody = document.getElementById('searchTableBody');

                        if (searchData.length === 0) {
                            tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="fas fa-search"></i>
                                <h3>No Search Data</h3>
                                <p>No browser searches recorded for this date</p>
                            </td>
                        </tr>`;
                            paginationControls.style.display = 'none';
                        } else {
                            // Show pagination if more than itemsPerPage
                            if (searchData.length > itemsPerPage) {
                                paginationControls.style.display = 'flex';
                                updateSearchPagination();
                            } else {
                                paginationControls.style.display = 'none';
                            }

                            // Display current page
                            displayCurrentSearchPage();
                        }

                        // Update top sites list
                        updateTopSearchList(searchData);
                    }

                    function displayCurrentSearchPage() {
                        const tbody = document.getElementById('searchTableBody');
                        const startIndex = (currentSearchPage - 1) * itemsPerPage;
                        const endIndex = startIndex + itemsPerPage;
                        const pageData = allSearchData.slice(startIndex, endIndex);

                        tbody.innerHTML = pageData.map(entry => {
                            const urlDisplay = entry.url ? `<a href="${escapeHtml(entry.url)}" target="_blank" style="color: #4f46e5; text-decoration: none; max-width: 300px; display: inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(entry.url)}</a>` : '<span style="color: #9ca3af;">No URL</span>';
                            return `
                    <tr>
                        <td>${formatTime(entry.timestamp)}</td>
                        <td>${urlDisplay}</td>
                        <td>${escapeHtml(entry.search_engine)}</td>
                        <td>${escapeHtml(entry.search_query)}</td>
                    </tr>
                `;
                        }).join('');

                        updateSearchPagination();
                    }

                    function updateSearchPagination() {
                        const totalPages = Math.ceil(allSearchData.length / itemsPerPage);
                        const paginationInfo = document.getElementById('searchPaginationInfo');
                        const prevBtn = document.getElementById('searchPrevBtn');
                        const nextBtn = document.getElementById('searchNextBtn');
                        const pageNumbers = document.getElementById('searchPageNumbers');

                        // Update info
                        const startItem = (currentSearchPage - 1) * itemsPerPage + 1;
                        const endItem = Math.min(currentSearchPage * itemsPerPage, allSearchData.length);
                        paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${allSearchData.length}`;

                        // Update buttons
                        prevBtn.disabled = currentSearchPage === 1;
                        nextBtn.disabled = currentSearchPage === totalPages;

                        // Update page numbers
                        pageNumbers.innerHTML = '';
                        const maxVisiblePages = 5;
                        let startPage = Math.max(1, currentSearchPage - Math.floor(maxVisiblePages / 2));
                        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                        if (endPage - startPage < maxVisiblePages - 1) {
                            startPage = Math.max(1, endPage - maxVisiblePages + 1);
                        }

                        if (startPage > 1) {
                            const firstBtn = document.createElement('button');
                            firstBtn.className = 'page-number';
                            firstBtn.textContent = '1';
                            firstBtn.onclick = () => goToSearchPage(1);
                            pageNumbers.appendChild(firstBtn);

                            if (startPage > 2) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }
                        }

                        for (let i = startPage; i <= endPage; i++) {
                            const pageBtn = document.createElement('button');
                            pageBtn.className = 'page-number' + (i === currentSearchPage ? ' active' : '');
                            pageBtn.textContent = i;
                            pageBtn.onclick = () => goToSearchPage(i);
                            pageNumbers.appendChild(pageBtn);
                        }

                        if (endPage < totalPages) {
                            if (endPage < totalPages - 1) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.padding = '0 5px';
                                pageNumbers.appendChild(ellipsis);
                            }

                            const lastBtn = document.createElement('button');
                            lastBtn.className = 'page-number';
                            lastBtn.textContent = totalPages;
                            lastBtn.onclick = () => goToSearchPage(totalPages);
                            pageNumbers.appendChild(lastBtn);
                        }
                    }

                    function changeSearchPage(direction) {
                        const totalPages = Math.ceil(allSearchData.length / itemsPerPage);
                        const newPage = currentSearchPage + direction;

                        if (newPage >= 1 && newPage <= totalPages) {
                            currentSearchPage = newPage;
                            displayCurrentSearchPage();
                            // Scroll to top of table
                            document.getElementById('searchTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }

                    function goToSearchPage(page) {
                        const totalPages = Math.ceil(allSearchData.length / itemsPerPage);
                        if (page >= 1 && page <= totalPages) {
                            currentSearchPage = page;
                            displayCurrentSearchPage();
                            // Scroll to top of table
                            document.getElementById('searchTableBody').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }

                    function updateTopSearchList(searchData) {
                        const listContainer = document.getElementById('topSearchListBody');
                        if (!listContainer) return;

                        if (!searchData || searchData.length === 0) {
                            listContainer.innerHTML = '<div style="text-align: center; color: #9ca3af;">No browser activity for this date</div>';
                            return;
                        }

                        // We want recent sites, so we just take the raw searchData (already sorted by time desc)
                        // and deduplicate by host if needed, or just show the stream.
                        // The user asked for "recent sites visited", implying a chronological list.
                        // However, to keep it clean like the previous "Top Sites", we might want to still group by host
                        // but order by the *most recent* visit to that host.

                        const hostUsage = {};
                        searchData.forEach(entry => {
                            const url = entry.url || '';
                            let host;
                            if (url) {
                                try {
                                    const parsed = new URL(url);
                                    host = parsed.hostname || url;
                                } catch {
                                    host = url;
                                }
                            } else {
                                host = entry.search_engine || entry.browser || 'Unknown Source';
                            }
                            const key = host || 'Unknown Source';

                            if (!hostUsage[key]) {
                                hostUsage[key] = { lastEntry: entry };
                            }
                            // Keep the most recent entry for this host
                            if (entry.timestamp && (!hostUsage[key].lastEntry.timestamp || new Date(entry.timestamp) > new Date(hostUsage[key].lastEntry.timestamp))) {
                                hostUsage[key].lastEntry = entry;
                            }
                        });

                        // Sort by timestamp descending (most recent first)
                        const recentHosts = Object.entries(hostUsage)
                            .sort((a, b) => {
                                const timeA = a[1].lastEntry.timestamp ? new Date(a[1].lastEntry.timestamp) : new Date(0);
                                const timeB = b[1].lastEntry.timestamp ? new Date(b[1].lastEntry.timestamp) : new Date(0);
                                return timeB - timeA;
                            })
                            .slice(0, 5);

                        listContainer.innerHTML = recentHosts.map(([host, data], index) => {
                            const url = data.lastEntry.url || '';
                            const rawTitle = data.lastEntry.search_query || host;
                            const title = rawTitle.length > 80 ? `${rawTitle.slice(0, 77)}...` : rawTitle;
                            const timestamp = data.lastEntry.timestamp ? formatTime(data.lastEntry.timestamp) : 'Unknown time';
                            const link = url ? `<a href="${escapeHtml(url)}" target="_blank" style="color:#4f46e5;text-decoration:none;word-break:break-all;">${escapeHtml(url)}</a>` : '<span style="color:#9ca3af;">No URL captured</span>';

                            return `
                        <div style="display:flex;align-items:flex-start;gap:12px;padding:12px;border-bottom:1px solid #f3f4f6;">
                            <div style="font-weight:700;color:#4f46e5;">${index + 1}.</div>
                            <div style="flex:1;">
                                <div style="font-weight:600;color:#1f2937;">${escapeHtml(host)}</div>
                                <div style="font-size:0.9rem;color:#6b7280;margin:4px 0;">${escapeHtml(title)}</div>
                                <div style="font-size:0.8rem;color:#9ca3af;margin-bottom:6px;">
                                    <i class="fas fa-clock"></i> ${timestamp}
                                </div>
                                <div style="font-size:0.85rem;">${link}</div>
                            </div>
                        </div>
                    `;
                        }).join('');
                    }

                    function switchTab(tabName) {
                        // Hide all tabs
                        document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
                        document.querySelectorAll('.tab-btn').forEach(btn => {
                            btn.classList.remove('active');
                            btn.style.color = '#64748b';
                            btn.style.borderBottomColor = 'transparent';
                        });

                        // Show selected tab
                        const targetTab = document.getElementById(`${tabName}-tab`);
                        const activeBtn = document.getElementById(`tab-btn-${tabName}`);

                        if (!targetTab || !activeBtn) return;

                        if (tabName === 'processes') {
                            const pcName = document.getElementById('pcName').value.trim();
                            if (!pcName) {
                                alert('Please enter a PC name first');
                                // Fallback to apps tab
                                document.getElementById('apps-tab').style.display = 'block';
                                const appsBtn = document.getElementById('tab-btn-apps');
                                appsBtn.classList.add('active');
                                appsBtn.style.color = '#4f46e5';
                                appsBtn.style.borderBottomColor = '#4f46e5';
                                return;
                            }
                            showTaskManager(pcName);
                        } else {
                            hideTaskManager();
                        }

                        targetTab.style.display = 'block';
                        activeBtn.classList.add('active');
                        activeBtn.style.color = '#4f46e5';
                        activeBtn.style.borderBottomColor = '#4f46e5';

                        // Scroll to tabs navigation if we are below it
                        const anchor = document.getElementById('tabs-start-anchor');
                        if (anchor) {
                            const rect = anchor.getBoundingClientRect();
                            // If anchor is above the viewport top (negative top), we are scrolled past it
                            if (rect.top < 0) {
                                anchor.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'start'
                                });
                            }
                        }
                    }


                    function updatePcStatus(pcName, isOnline, statusData, systemInfo, selectedDate) {
                        const statusIndicator = document.getElementById('statusIndicator');
                        const pcDisplayName = document.getElementById('pcDisplayName');
                        const pcStatusText = document.getElementById('pcStatusText');
                        const systemInfoGrid = document.getElementById('systemInfoGrid');
                        const pcStatusContainer = document.getElementById('pcStatusContainer');

                        // Make sure the container is visible
                        if (pcStatusContainer) {
                            pcStatusContainer.style.display = 'block';
                        }

                        if (!pcDisplayName || !pcStatusText || !statusIndicator) {
                            console.error('PC status elements not found');
                            return;
                        }

                        pcDisplayName.textContent = pcName;

                        // Check idle status
                        const isIdle = statusData && statusData.is_idle === true;

                        let statusIcon, statusLabel, statusColor;
                        if (!isOnline) {
                            statusIcon = 'fa-times-circle';
                            statusLabel = 'Offline';
                            statusColor = '#ef4444';
                        } else if (isIdle) {
                            statusIcon = 'fa-moon';
                            statusLabel = 'Idle';
                            statusColor = '#f59e0b';
                        } else {
                            statusIcon = 'fa-check-circle';
                            statusLabel = 'Online';
                            statusColor = '#22c55e';
                        }

                        pcStatusText.innerHTML = `
                <i class="fas ${statusIcon}" style="color: ${statusColor}"></i>
                <span>${statusLabel}</span>
            `;

                        if (isOnline) {
                            statusIndicator.classList.remove('offline');
                            if (isIdle) {
                                statusIndicator.classList.add('idle');
                            } else {
                                statusIndicator.classList.remove('idle');
                            }
                        } else {
                            statusIndicator.classList.add('offline');
                            statusIndicator.classList.remove('idle');
                        }

                        console.log('PC Status updated:', { pcName, isOnline, hasStatusData: !!statusData, hasSystemInfo: !!systemInfo });

                        // Display system info
                        if (systemInfo) {
                            systemInfoGrid.innerHTML = `
                    ${systemInfo.cpu_model ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-microchip"></i> CPU</div>
                            <div class="value">${escapeHtml(systemInfo.cpu_model)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.cpu_cores ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-layer-group"></i> Cores</div>
                            <div class="value">${systemInfo.cpu_cores}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.cpu_speed_ghz ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-tachometer-alt"></i> CPU Speed</div>
                            <div class="value">${systemInfo.cpu_speed_ghz} GHz</div>
                        </div>
                    ` : ''}
                    ${systemInfo.total_memory_gb ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-memory"></i> RAM</div>
                            <div class="value">${systemInfo.total_memory_gb} GB</div>
                        </div>
                    ` : ''}
                    ${systemInfo.os_platform ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-desktop"></i> OS</div>
                            <div class="value">${escapeHtml(systemInfo.os_platform)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.os_version ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-code-branch"></i> OS Version</div>
                            <div class="value">${escapeHtml(systemInfo.os_version)}</div>
                        </div>
                    ` : ''}
                    ${systemInfo.hostname ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-network-wired"></i> Hostname</div>
                            <div class="value">${escapeHtml(systemInfo.hostname)}</div>
                        </div>
                    ` : ''}
                    ${statusData && statusData.last_seen ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-clock"></i> Last Seen</div>
                            <div class="value">${formatDateTime(statusData.last_seen)}</div>
                        </div>
                    ` : ''}
                `;
                        } else {
                            // Show basic info if system_info not available
                            systemInfoGrid.innerHTML = `
                    ${statusData && statusData.last_seen ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-clock"></i> Last Seen</div>
                            <div class="value">${formatDateTime(statusData.last_seen)}</div>
                        </div>
                    ` : ''}
                    ${!systemInfo ? `
                        <div class="system-info-item">
                            <div class="label"><i class="fas fa-info-circle"></i> System Info</div>
                            <div class="value">Not Available</div>
                        </div>
                    ` : ''}
                `;
                        }

                        document.getElementById('pcStatusContainer').style.display = 'block';

                        // Update shareable link (use the selectedDate from the function parameter)
                        updateShareableLink(pcName, selectedDate);
                    }

                    function updateShareableLink(pcName, date) {
                        // Use hardcoded URL as requested
                        const currentURL = 'https://ast4rt3.github.io/scanner_mobile/index.html';
                        const url = new URL(currentURL);
                        url.searchParams.set('pc', pcName);
                        // Date parameter removed as requested
                        // if (date) {
                        //     url.searchParams.set('date', date);
                        // }
                        const shareableLink = document.getElementById('shareableLink');
                        if (shareableLink) {
                            shareableLink.value = url.toString();
                        }
                    }

                    function copyLink(event) {
                        const linkInput = document.getElementById('shareableLink');
                        if (!linkInput.value) return;

                        linkInput.select();
                        linkInput.setSelectionRange(0, 99999); // For mobile devices

                        const copyToClipboard = () => {
                            try {
                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                    navigator.clipboard.writeText(linkInput.value).then(() => {
                                        showCopyFeedback(event);
                                    }).catch(() => {
                                        // Fallback to execCommand
                                        document.execCommand('copy');
                                        showCopyFeedback(event);
                                    });
                                } else {
                                    // Fallback for older browsers
                                    document.execCommand('copy');
                                    showCopyFeedback(event);
                                }
                            } catch (err) {
                                console.error('Failed to copy:', err);
                            }
                        };

                        copyToClipboard();
                    }

                    function showCopyFeedback(event) {
                        const button = event ? event.target.closest('button') : document.querySelector('button[onclick="copyLink()"]');
                        if (!button) return;

                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        button.style.background = '#22c55e';
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.style.background = '#4f46e5';
                        }, 2000);
                    }


                    function formatTime(timeString) {
                        if (!timeString) return 'N/A';
                        try {
                            let date;

                            // Handle Date object
                            if (timeString instanceof Date) {
                                date = timeString;
                            } else if (typeof timeString === 'number') {
                                // Unix ms timestamp
                                date = new Date(timeString);
                            } else if (typeof timeString === 'string') {
                                // ISO with explicit timezone (Z or +/-offset)
                                if (timeString.includes('T') && (timeString.includes('Z') || /[+-]\d{2}:\d{2}$/.test(timeString))) {
                                    date = new Date(timeString);
                                }
                                // Legacy format: "YYYY-MM-DD HH:MM AM/PM"
                                else if (timeString.includes('AM') || timeString.includes('PM')) {
                                    const parts = timeString.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})\s+(AM|PM)/);
                                    if (parts) {
                                        let year = parseInt(parts[1]);
                                        let month = parseInt(parts[2]) - 1;
                                        let day = parseInt(parts[3]);
                                        let hour = parseInt(parts[4]);
                                        let minute = parseInt(parts[5]);
                                        const ampm = parts[6];
                                        if (ampm === 'PM' && hour !== 12) hour += 12;
                                        if (ampm === 'AM' && hour === 12) hour = 0;
                                        date = new Date(year, month, day, hour, minute);
                                    } else {
                                        date = new Date(timeString);
                                    }
                                }
                                // ISO-like without explicit timezone
                                else if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/.test(timeString)) {
                                    // Treat ISO-like without timezone as UTC to avoid browser local misinterpretation
                                    date = new Date(timeString.endsWith('Z') ? timeString : timeString + 'Z');
                                } else {
                                    date = new Date(timeString);
                                }
                            }

                            if (!date || isNaN(date.getTime())) {
                                return timeString;
                            }

                            return date.toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true,
                                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                            });
                        } catch (e) {
                            return timeString;
                        }
                    }

                    function formatDateTime(dateTimeString) {
                        if (!dateTimeString) return 'N/A';
                        try {
                            // Normalize incoming string
                            if (typeof dateTimeString === 'string') {
                                // Trim whitespace
                                dateTimeString = dateTimeString.trim();
                                // Pad fractional seconds to 3 digits if only 1-2 are present (e.g., .57 -> .570)
                                dateTimeString = dateTimeString.replace(/(T\d{2}:\d{2}:\d{2})\.(\d{1,2})(?=(Z|[+-]\d{2}:\d{2}))/,
                                    (m, t, frac, tz) => `${t}.${frac.padEnd(3, '0')}${tz}`);
                            }
                            let date;

                            // Check if it's an ISO string (new format from server)
                            if (typeof dateTimeString === 'string' && dateTimeString.includes('T') && dateTimeString.includes('Z')) {
                                // ISO string with timezone - parse directly
                                date = new Date(dateTimeString);
                            }
                            // Handle legacy format: "YYYY-MM-DD HH:MM AM/PM" (old format)
                            else if (typeof dateTimeString === 'string' && (dateTimeString.includes('AM') || dateTimeString.includes('PM'))) {
                                // Parse the custom format: "2025-11-09 09:23 PM"
                                const parts = dateTimeString.match(/(\d{4})-(\d{2})-(\d{2})\s+(\d{1,2}):(\d{2})\s+(AM|PM)/);
                                if (parts) {
                                    let year = parseInt(parts[1]);
                                    let month = parseInt(parts[2]) - 1; // Month is 0-indexed
                                    let day = parseInt(parts[3]);
                                    let hour = parseInt(parts[4]);
                                    let minute = parseInt(parts[5]);
                                    let ampm = parts[6];

                                    // Convert to 24-hour format
                                    if (ampm === 'PM' && hour !== 12) {
                                        hour += 12;
                                    } else if (ampm === 'AM' && hour === 12) {
                                        hour = 0;
                                    }

                                    // Create date in local timezone (not UTC)
                                    date = new Date(year, month, day, hour, minute);
                                } else {
                                    // Fallback to standard Date parsing
                                    date = new Date(dateTimeString);
                                }
                            } else {
                                // Standard ISO date string (without Z) or other format
                                // If it looks like an ISO string without timezone, treat as UTC
                                if (typeof dateTimeString === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(dateTimeString)) {
                                    // If it already has an explicit timezone offset like +08:00 or -05:00, keep it
                                    if (/[+-]\d{2}:\d{2}$/.test(dateTimeString)) {
                                        date = new Date(dateTimeString);
                                    } else {
                                        // No timezone info: treat as UTC
                                        date = new Date(dateTimeString.endsWith('Z') ? dateTimeString : dateTimeString + 'Z');
                                    }
                                } else {
                                    date = new Date(dateTimeString);
                                }
                            }

                            if (isNaN(date.getTime())) {
                                // If still invalid, return as-is
                                return dateTimeString;
                            }

                            // Format using local timezone (browser's timezone)
                            return date.toLocaleString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: true,
                                timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                            });
                        } catch (e) {
                            console.error('Error formatting date:', dateTimeString, e);
                            return dateTimeString;
                        }
                    }

                    function formatDuration(seconds) {
                        if (!seconds) return '0m';
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        if (hours > 0) {
                            return `${hours}h ${minutes}m`;
                        }
                        return `${minutes}m`;
                    }

                    function formatBytes(bytes) {
                        if (!bytes) return '0 B';
                        const mb = bytes / (1024 * 1024);
                        return `${Math.round(mb * 10) / 10} MB`;
                    }

                    function escapeHtml(unsafe) {
                        if (typeof unsafe !== 'string') return '';
                        return unsafe
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    }

                    // Task Manager Functions - Fetch from Supabase
                    async function loadTaskManagerData(pcName) {
                        const sanitizedPcName = sanitizePcNameInput(pcName);
                        if (!sanitizedPcName) return;
                        const pcNameFilter = buildCaseInsensitiveFilter(sanitizedPcName);

                        try {
                            // Get recent app usage logs from the last 60 seconds
                            const now = new Date();
                            const sixtySecondsAgo = new Date(now.getTime() - 60000);

                            const { data: logs, error } = await supabase
                                .from('app_usage_logs')
                                .select('cpu_percent, memory_usage_bytes, end_time')
                                .ilike('pc_name', pcNameFilter)
                                .gte('end_time', sixtySecondsAgo.toISOString())
                                .order('end_time', { ascending: true })
                                .limit(100);

                            if (error) {
                                throw error;
                            }

                            // Get system info
                            const systemInfo = await fetchPcRowCaseInsensitive('system_info', pcNameFilter);

                            // Get latest stats
                            const { data: latestLog } = await supabase
                                .from('app_usage_logs')
                                .select('cpu_percent, memory_usage_bytes')
                                .ilike('pc_name', pcNameFilter)
                                .order('end_time', { ascending: false })
                                .limit(1)
                                .single();

                            // Format data for charts
                            const cpuData = (logs || []).map(log => ({
                                time: new Date(log.end_time).getTime(),
                                value: parseFloat(log.cpu_percent) || 0
                            }));

                            const memoryData = (logs || []).map(log => ({
                                time: new Date(log.end_time).getTime(),
                                value: parseInt(log.memory_usage_bytes) || 0
                            }));

                            const data = {
                                cpu: cpuData,
                                memory: memoryData,
                                lastUpdate: Date.now(),
                                systemInfo: systemInfo,
                                latestStats: latestLog ? {
                                    cpuPercent: latestLog.cpu_percent,
                                    memoryBytes: latestLog.memory_usage_bytes
                                } : null
                            };

                            updateTaskManager(data, pcName);
                        } catch (error) {
                            console.error('Error loading task manager data:', error);
                            // Show error state
                            const cpuUtilEl = document.getElementById('cpuUtilization');
                            const cpuSpeedEl = document.getElementById('cpuSpeed');
                            if (cpuUtilEl) cpuUtilEl.textContent = 'Error';
                            if (cpuSpeedEl) cpuSpeedEl.textContent = 'Error';
                        }
                    }

                    function updateTaskManager(data, pcName) {
                        // Update CPU chart
                        if (data.cpu && data.cpu.length > 0) {
                            updateCPUChart(data.cpu);
                            const latestCpu = data.cpu[data.cpu.length - 1];
                            document.getElementById('cpuUtilization').textContent = `${latestCpu.value.toFixed(1)}%`;
                        }

                        // Update Memory chart
                        if (data.memory && data.memory.length > 0) {
                            updateMemoryChart(data.memory, data.systemInfo);
                            const latestMemory = data.memory[data.memory.length - 1];
                            const memoryGB = (latestMemory.value / (1024 * 1024 * 1024)).toFixed(2);
                            const totalMemoryGB = data.systemInfo ? data.systemInfo.total_memory_gb : null;
                            if (totalMemoryGB) {
                                const availableGB = (totalMemoryGB - parseFloat(memoryGB)).toFixed(2);
                                document.getElementById('memoryInUse').textContent = `${memoryGB} GB`;
                                document.getElementById('memoryAvailable').textContent = `${availableGB} GB`;
                            }
                        }

                        // Update system info
                        if (data.systemInfo) {
                            const info = data.systemInfo;
                            if (info.cpu_model) {
                                document.getElementById('cpuModel').textContent = info.cpu_model;
                            }
                            if (info.cpu_speed_ghz) {
                                document.getElementById('baseSpeed').textContent = `${info.cpu_speed_ghz.toFixed(2)} GHz`;
                                // Use latest stats for current speed if available
                                if (data.latestStats && data.latestStats.cpuPercent) {
                                    // Estimate current speed based on utilization (rough estimate)
                                    const estimatedSpeed = info.cpu_speed_ghz * (1 + (data.latestStats.cpuPercent / 100) * 0.1);
                                    document.getElementById('cpuSpeed').textContent = `${estimatedSpeed.toFixed(2)} GHz`;
                                } else {
                                    document.getElementById('cpuSpeed').textContent = `${info.cpu_speed_ghz.toFixed(2)} GHz`;
                                }
                            }
                            if (info.cpu_cores) {
                                document.getElementById('cores').textContent = info.cpu_cores;
                                document.getElementById('logicalProcessors').textContent = info.cpu_cores * 2; // Estimate
                            }
                            document.getElementById('sockets').textContent = '1';
                            document.getElementById('virtualization').textContent = 'Enabled';
                            document.getElementById('l1Cache').textContent = '128 KB';
                            document.getElementById('l2Cache').textContent = '512 KB';
                            document.getElementById('l3Cache').textContent = '4.0 MB';
                        }

                        // Update stats (these would need to come from the client, for now show placeholders)
                        const memoryCommittedEl = document.getElementById('memoryCommitted');
                        if (memoryCommittedEl) {
                            memoryCommittedEl.textContent = '-';
                        }
                    }

                    function updateCPUChart(cpuData) {
                        const ctx = document.getElementById('cpuUtilizationChart');
                        if (!ctx) return;

                        const labels = cpuData.map((point, index) => {
                            const secondsAgo = Math.floor((Date.now() - point.time) / 1000);
                            return `${secondsAgo}s`;
                        });
                        const values = cpuData.map(point => point.value);

                        if (cpuChart) {
                            cpuChart.data.labels = labels;
                            cpuChart.data.datasets[0].data = values;
                            cpuChart.update('none');
                        } else {
                            cpuChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'CPU Utilization',
                                        data: values,
                                        borderColor: '#00d4ff',
                                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: {
                                                color: '#64748b',
                                                font: {
                                                    size: 11
                                                }
                                            },
                                            grid: {
                                                color: '#e5e7eb'
                                            }
                                        },
                                        x: {
                                            ticks: {
                                                color: '#64748b',
                                                font: {
                                                    size: 11
                                                }
                                            },
                                            grid: {
                                                color: '#e5e7eb'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }

                    function updateMemoryChart(memoryData, systemInfo) {
                        const ctx = document.getElementById('memoryUtilizationChart');
                        if (!ctx) return;

                        const labels = memoryData.map((point, index) => {
                            const secondsAgo = Math.floor((Date.now() - point.time) / 1000);
                            return `${secondsAgo}s`;
                        });
                        const values = memoryData.map(point => (point.value / (1024 * 1024 * 1024)).toFixed(2));
                        const maxMemory = systemInfo && systemInfo.total_memory_gb ? systemInfo.total_memory_gb : Math.max(...values) * 1.2;

                        if (memoryChart) {
                            memoryChart.data.labels = labels;
                            memoryChart.data.datasets[0].data = values;
                            memoryChart.options.scales.y.max = maxMemory;
                            memoryChart.update('none');
                        } else {
                            memoryChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Memory Usage',
                                        data: values,
                                        borderColor: '#00d4ff',
                                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                                        borderWidth: 2,
                                        fill: true,
                                        tension: 0.4,
                                        pointRadius: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: maxMemory,
                                            ticks: {
                                                color: '#64748b',
                                                font: {
                                                    size: 11
                                                }
                                            },
                                            grid: {
                                                color: '#e5e7eb'
                                            }
                                        },
                                        x: {
                                            ticks: {
                                                color: '#64748b',
                                                font: {
                                                    size: 11
                                                }
                                            },
                                            grid: {
                                                color: '#e5e7eb'
                                            }
                                        }
                                    }
                                }
                            });
                        }
                    }

                    function startTaskManagerRefresh(pcName) {
                        stopTaskManagerRefresh();
                        if (!pcName) return;

                        // Load immediately
                        loadTaskManagerData(pcName);

                        // Then refresh every 3 seconds
                        taskManagerRefreshInterval = setInterval(() => {
                            loadTaskManagerData(pcName);
                        }, TASK_MANAGER_REFRESH_INTERVAL);
                    }

                    function stopTaskManagerRefresh() {
                        if (taskManagerRefreshInterval) {
                            clearInterval(taskManagerRefreshInterval);
                            taskManagerRefreshInterval = null;
                        }
                    }

                    function showTaskManager(pcName) {
                        if (!pcName) {
                            alert('Please enter a PC name first');
                            return;
                        }
                        startTaskManagerRefresh(pcName);
                    }

                    function hideTaskManager() {
                        stopTaskManagerRefresh();
                    }

                    function showHome() {
                        // Stop any active refreshes
                        stopAutoRefresh();
                        hideTaskManager();

                        // Switch views
                        document.getElementById('detailPage').classList.remove('active');
                        document.getElementById('homePage').classList.add('active');
                        document.getElementById('homePage').scrollIntoView({ behavior: 'smooth', block: 'start' });

                        // Update navbar
                        document.getElementById('nav-home').classList.add('active');
                        document.getElementById('nav-dashboard').classList.remove('active');
                        // navbarSubtitle removed - search inputs are in navbar now

                        // Clear URL params
                        const url = new URL(window.location);
                        url.searchParams.delete('pc');
                        url.searchParams.delete('date');
                        window.history.pushState({}, '', url);
                    }

                    // Page navigation function
                    function showPage(pageName) {
                        // Stop any active refreshes
                        stopAutoRefresh();
                        hideTaskManager();

                        // Hide all pages
                        document.getElementById('homePage').classList.remove('active');
                        document.getElementById('detailPage').classList.remove('active');
                        document.getElementById('analyticsPage').classList.remove('active');
                        document.getElementById('notificationsPage').classList.remove('active');
                        document.getElementById('settingsPage').classList.remove('active');

                        // Update navbar
                        document.querySelectorAll('.navbar-item').forEach(item => item.classList.remove('active'));

                        // Show selected page
                        if (pageName === 'home') {
                            document.getElementById('homePage').classList.add('active');
                            document.getElementById('nav-home').classList.add('active');
                            document.getElementById('homePage').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // Hide right sidebar
                            toggleRightSidebar(false);
                            // Clear URL params
                            const url = new URL(window.location);
                            url.searchParams.delete('pc');
                            url.searchParams.delete('date');
                            window.history.pushState({}, '', url);
                        } else if (pageName === 'analytics') {
                            document.getElementById('analyticsPage').classList.add('active');
                            document.getElementById('nav-analytics').classList.add('active');
                            document.getElementById('analyticsPage').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // Hide right sidebar
                            toggleRightSidebar(false);
                        } else if (pageName === 'notifications') {
                            document.getElementById('notificationsPage').classList.add('active');
                            document.getElementById('nav-notifications').classList.add('active');
                            document.getElementById('notificationsPage').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // Hide right sidebar
                            toggleRightSidebar(false);
                        } else if (pageName === 'settings') {
                            document.getElementById('settingsPage').classList.add('active');
                            document.getElementById('nav-settings').classList.add('active');
                            document.getElementById('settingsPage').scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // Hide right sidebar
                            toggleRightSidebar(false);
                        }
                    }

                    // Dark mode toggle
                    function toggleDarkMode() {
                        const isDark = document.getElementById('darkModeToggle').checked;
                        if (isDark) {
                            document.body.classList.add('dark-mode');
                            localStorage.setItem('darkMode', 'enabled');
                        } else {
                            document.body.classList.remove('dark-mode');
                            localStorage.setItem('darkMode', 'disabled');
                        }
                    }

                    // Load dark mode preference on page load
                    window.addEventListener('DOMContentLoaded', () => {
                        const darkMode = localStorage.getItem('darkMode');
                        if (darkMode === 'enabled') {
                            document.getElementById('darkModeToggle').checked = true;
                            toggleDarkMode();
                        }
                    });

                    // Update showHome to use showPage
                    function showHome() {
                        showPage('home');
                    }

                    // Scroll to section function
                    function scrollToSection(sectionId) {
                        const element = document.getElementById(sectionId);
                        if (element) {
                            // Scroll with offset for fixed navbar
                            const yOffset = -50; // Offset for navbar height (adjusted to show content lower)
                            const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;

                            window.scrollTo({
                                top: y,
                                behavior: 'smooth'
                            });

                            // Update active state in sidebar
                            document.querySelectorAll('.sidebar-nav-item').forEach(item => {
                                item.classList.remove('active');
                            });

                            // Find and activate the clicked item
                            const clickedItem = document.querySelector(`a[href="#${sectionId}"]`);
                            if (clickedItem) {
                                clickedItem.classList.add('active');
                            }
                        }
                    }

                    // Scroll handler for Quick Jump visibility
                    function handleQuickJumpScroll() {
                        const sidebar = document.getElementById('rightSidebar');
                        if (!sidebar) return;

                        // Only show if at the very top (with small buffer)
                        if (window.pageYOffset < 20) {
                            sidebar.classList.add('active');
                        } else {
                            sidebar.classList.remove('active');
                        }
                    }

                    // Show/hide right sidebar based on page
                    function toggleRightSidebar(show) {
                        const sidebar = document.getElementById('rightSidebar');
                        if (sidebar) {
                            if (show) {
                                // Initial check
                                handleQuickJumpScroll();
                                // Add scroll listener
                                window.addEventListener('scroll', handleQuickJumpScroll);
                            } else {
                                sidebar.classList.remove('active');
                                // Remove scroll listener
                                window.removeEventListener('scroll', handleQuickJumpScroll);
                            }
                        }
                    }
                </script>
</body>

</html>
